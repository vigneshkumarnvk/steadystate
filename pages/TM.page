<!-- <apex:page language="{!$CurrentPage.parameters.lang}" standardController="TM__c" extensions="TMController" id="thePage" -->
<apex:page language="{!$CurrentPage.parameters.lang}" standardController="TM__c" id="thePage"
           sidebar="false">
    <!--
    <apex:stylesheet value="{!URLFOR($Resource.GoldFinch, '/css/style.css')}"/>
    <apex:stylesheet value="https://code.jquery.com/ui/1.10.3/themes/smoothness/jquery-ui.css"/>
    <script type="text/javascript" src="//code.jquery.com/jquery-2.1.4.min.js">
    </script>
    <script type="text/javascript" src="//code.jquery.com/ui/1.11.4/jquery-ui.min.js">
    </script>
    <script src="{!URLFOR($Resource.Typeahead, '/typeahead.bundle.min.js')}"></script>
    <head>
        <style>

            .tmLineWrap input[type="text"], .slds-scope input[type="text"] {
                max-width: 100px;
            }

            body td.actionColumn:before, .slds-scope td.actionColumn:before {
                display: none;
            }

            body .list .actionColumn, .slds-scope .list .actionColumn {
                padding-left: 0px;
            }

            .tmLineWrap {
                overflow: scroll;
            }
        </style>
    </head>
    <script>
        $ = jQuery.noConflict();

        $(document).ready(function () {
            $(document.getElementById("{!$Component.theForm.thePageBlock.theSection.theSILTable}")).find("tbody").sortable().on("sortstart", function (event, ui) {
            }).on("sortstop", function (event, ui) {
            }).on("sortchange", function (event, ui) {
            }).on("sortupdate", function (event, ui) {
                var elements = $(document.getElementById("{!$Component.theForm.thePageBlock.theSection.theSILTable}")).find("tbody").find('tr').find('td').find('input');
                var j = 0;
                for (var i = 0; i < elements.length; i++) {
                    if (elements[i].id.indexOf(":theLineNo") > 0) {
                        j++;
                        elements[i].value = j * 10;
                    }
                }
            });

            $("input").keypress(function (event) {
                if (event.keyCode == 13) {
                    return false;
                }
            });
        });

        $(document).ready(function () {
            //$(".tmLineWrap").css("max-width", (screen.width-100));
        });

        function setFocusOnLoad() {
        }

        function confirmDelete(a) {
            a || (a = LC.getLabel("Global", "are_you_sure"));
            return Modal.confirm(a);
        }

        function confirmCopyTime(lineType) {
            var result = confirm("Are you sure to copy times to other T&M " + lineType + " lines?");
            if (!result) {
                return false;
            }

            return true;
        }

        var focuselmnt;

        /*
            Ticket#18265 add theTMLDemurrageContractLine to the fieldNames
        */
        function validateFieldInList(fieldThatChanged) {
            var elemenetIdForField = fieldThatChanged.id;
            focuselmnt = elemenetIdForField.replace('theItem', 'theQuantity');
            var lastColonPosition = elemenetIdForField.lastIndexOf(':');
            var secondToLastColonPosition = elemenetIdForField.lastIndexOf(':', lastColonPosition - 1);
            //alert (elemenetIdForField +"/" + lastColonPosition + "/" + secondToLastColonPosition);
            var fieldName = (elemenetIdForField.substr(lastColonPosition + 1));
            var lineNo = (elemenetIdForField.substr(secondToLastColonPosition + 1, (lastColonPosition - secondToLastColonPosition) - 1));
            if (fieldName == 'theJobPosition' || fieldName == 'theServiceCenter' || fieldName == 'theEServiceCenter' || fieldName == 'theUOM' || fieldName == 'theMResource' ||
                fieldName == 'theLResource' || fieldName == 'theEResource' || fieldName == 'theSResource' || fieldName == 'theFResource' || fieldName == 'theWResource' ||
                fieldName == 'theDResource' || fieldName == 'theLUOM' || fieldName == 'theMUOM' || fieldName == 'theEUOM' || fieldName == 'theSUOM' ||
                fieldName == 'theFUOM' || fieldName == 'theWUOM' || fieldName == 'theDUOM' || fieldName == 'theLumpUOM' || fieldName == 'theMiscUOM' ||
                fieldName == 'theEquipment' || fieldName == 'theLContractLine' || fieldName == 'theEContractLine' || fieldName == 'theMContractLine' ||
                fieldName == 'theLumpSumResourceType' || fieldName == 'theLumpSumContractLine' || fieldName == 'theTaxArea' || fieldName == 'theMiscResource' ||
                fieldName == 'theWDContractLine' || fieldName == 'theWUnitVol' || fieldName == 'theWFacility' || fieldName == 'theWContainerSize' || fieldName == 'theTMLDemurrageContractLine') {
                    var newFieldValue = document.getElementById(elemenetIdForField + "_lkid").value;
                }
                else if (fieldName == 'theUsePremiumRate' || fieldName == 'theBillSiteTime' || fieldName == 'theLBillasLumpSum' || fieldName == 'theEBillasLumpSum' ||
                        fieldName == 'theMBillasLumpSum' || fieldName == 'theSBillasLumpSum' || fieldName == 'theDBillasLumpSum' || fieldName == 'theMiscBillasLumpSum' ||
                        fieldName == 'theWBillasLumpSum' || fieldName == 'theLNonBillable' || fieldName == 'theENonBillable' || fieldName == 'theMNonBillable' ||
                        fieldName == 'theSNonBillable' || fieldName == 'theDNonBillable' || fieldName == 'theMiscNonBillable' || fieldName == 'theWNonBillable' ||
                        fieldName == 'theInclLunchYN' || fieldName == 'laborDispatchFromHome' || fieldName == 'selectedLabor') {
                var newFieldValue = document.getElementById(elemenetIdForField).checked;
                } else if (fieldName == 'theELunch'){
                    var e = document.getElementById(elemenetIdForField);
                    var newFieldValue = e.options[e.selectedIndex].value;
            } else {
                var newFieldValue = document.getElementById(elemenetIdForField).value;
            }
            //alert (fieldName +"/" + newFieldValue + "/" + lineNo);
            setFocusElement(fieldName, elemenetIdForField);
            if(fieldName == 'theTaxArea') {
                lineNo = -1;
                validateTaxArea(fieldName, newFieldValue, lineNo);
            } else {
                validateField(fieldName, newFieldValue, lineNo);
            }
        }

        function setFocusElement(fieldName, elemenetIdForField) {
            switch (fieldName) {
                case "theJobPosition":
                    focuselmnt = elemenetIdForField.replace('theJobPosition', 'theLResource');
                    break;
                case "theLResource":
                    focuselmnt = elemenetIdForField.replace('theLResource', 'theDescription');
                    break;
                case "theDescription":
                    focuselmnt = elemenetIdForField.replace('theDescription', 'theJobStartTime');
                    break;
                case "theJobStartTime":
                    focuselmnt = elemenetIdForField.replace('theJobStartTime', 'theSiteStartTime');
                    break;
                case "theSiteStartTime":
                    focuselmnt = elemenetIdForField.replace('theSiteStartTime', 'theSiteEndTime');
                    break;
                case "theSiteEndTime":
                    focuselmnt = elemenetIdForField.replace('theSiteEndTime', 'theJobEndTime');
                    break;
                case "theJobEndTime":
                    focuselmnt = elemenetIdForField.replace('theJobEndTime', 'theLunchStartTime');
                    break;
                case "theLunchStartTime":
                    focuselmnt = elemenetIdForField.replace('theLunchStartTime', 'theLunchEndTime');
                    break;
                case "theLunchEndTime":
                    focuselmnt = elemenetIdForField.replace('theLunchEndTime', 'theLunch');
                    break;
                case "theLunch":
                    focuselmnt = elemenetIdForField.replace('theLunch', 'theBillSiteTime');
                    break;
                case "theBillSiteTime":
                    focuselmnt = elemenetIdForField.replace('theBillSiteTime', 'theBillingStartTime');
                    break;
                case "theBillingStartTime":
                    focuselmnt = elemenetIdForField.replace('theBillingStartTime', 'theBillingEndTime');
                    break;
                case "theBillingEndTime":
                    focuselmnt = elemenetIdForField.replace('theBillingEndTime', 'theRegularHour');
                    break;
                case "theRegularHour":
                    focuselmnt = elemenetIdForField.replace('theRegularHour', 'theOvertimeHour');
                    break;
                case "theOvertimeHour":
                    focuselmnt = elemenetIdForField.replace('theOvertimeHour', 'thePremiumHours');
                    break;
                case "thePremiumHours":
                    focuselmnt = elemenetIdForField.replace('thePremiumHours', 'theRegularRate');
                    break;
                case "theRegularRate":
                    focuselmnt = elemenetIdForField.replace('theRegularRate', 'theOvertimeRate');
                    break;
                case "thePremiumRate":
                    focuselmnt = elemenetIdForField.replace('thePremiumRate', 'theOvertimeRate');
                    break;
                case "theOvertimeRate":
                    focuselmnt = elemenetIdForField.replace('theOvertimeRate', 'thePremiumRate');
                    break;
                case "theUnitPrice":
                    focuselmnt = elemenetIdForField.replace('theUnitPrice', 'theLUOM');
                    break;
                case "theLUOM":
                    focuselmnt = elemenetIdForField.replace('theLUOM', 'theTaxGroup');
                    break;
                //Equipment Lines
                case "theEquipment":
                    focuselmnt = elemenetIdForField.replace('theEquipment', 'theEResource');
                    break;
                case "theEResource":
                    focuselmnt = elemenetIdForField.replace('theEResource', 'theESiteStartTime');
                    break;
                case "theESiteStartTime":
                    focuselmnt = elemenetIdForField.replace('theESiteStartTime', 'theESiteEndTime');
                    break;
                case "theESiteEndTime":
                    focuselmnt = elemenetIdForField.replace('theESiteEndTime', 'theEUOM');
                    break;
                // Material
                case "theMResource":
                    focuselmnt = elemenetIdForField.replace('theMResource', 'theMQuantity');
                    break;
                case "theMQuantity":
                    focuselmnt = elemenetIdForField.replace('theMQuantity', 'theMUOM');
                    break;
                case "theMUOM":
                    focuselmnt = elemenetIdForField.replace('theMUOM', 'theMUnitPrice');
                    break;
                case "theMUnitPrice":
                    focuselmnt = elemenetIdForField.replace('theMUnitPrice', 'theMTaxGroup');
                    break;

                //Subcontractor
                case "theSResource":
                    focuselmnt = elemenetIdForField.replace('theSResource', 'theSQuantity');
                    break;
                case "theSQuantity":
                    focuselmnt = elemenetIdForField.replace('theSQuantity', 'theSUOM');
                    break;
                case "theSUOM":
                    focuselmnt = elemenetIdForField.replace('theSUOM', 'theSUnitPrice');
                    break;
                case "theSUnitPrice":
                    focuselmnt = elemenetIdForField.replace('theSUnitPrice', 'theSMarkupOption');
                    break;
                case "theSMarkupOption":
                    focuselmnt = elemenetIdForField.replace('theSMarkupOption', 'theSMarkup');
                    break;
                case "theSMarkup":
                    focuselmnt = elemenetIdForField.replace('theSMarkup', 'theSTaxGroup');
                    break;


                //Waste Disposal
                case "theWQuantity":
                    focuselmnt = elemenetIdForField.replace('theWQuantity', 'theWUOM');
                    break;
                case "theWUOM":
                    focuselmnt = elemenetIdForField.replace('theWUOM', 'theWUnitPrice');
                    break;
                case "theWUnitPrice":
                    focuselmnt = elemenetIdForField.replace('theWUnitPrice', 'theWMarkupOption');
                    break;
                case "theWMarkupOption":
                    focuselmnt = elemenetIdForField.replace('theWMarkupOption', 'theWMarkup');
                    break;
                case "theWMarkup":
                    focuselmnt = elemenetIdForField.replace('theWMarkup', 'theWTaxGroup');
                    break;

                //Demurrage
                case "theDResource":
                    focuselmnt = elemenetIdForField.replace('theDResource', 'theDDescription');
                    break;
                case "theDDescription":
                    focuselmnt = elemenetIdForField.replace('theDDescription', 'theDSiteStartTime');
                    break;
                case "theDSiteStartTime":
                    focuselmnt = elemenetIdForField.replace('theDSiteStartTime', 'theDSiteEndTime');
                    break;
                case "theDSiteEndTime":
                    focuselmnt = elemenetIdForField.replace('theDSiteEndTime', 'theDUOM');
                    break;
                case "theDUOM":
                    focuselmnt = elemenetIdForField.replace('theDUOM', 'theDUnitPrice');
                    break;
                case "theDUnitPrice":
                    focuselmnt = elemenetIdForField.replace('theDUnitPrice', 'theDFuelSurcharge');
                    break;
                case "theDFuelSurcharge":
                    focuselmnt = elemenetIdForField.replace('theDFuelSurcharge', 'theDTaxGroup');
                    break;

                //Lump Sum
                case "theLumpDescription":
                    focuselmnt = elemenetIdForField.replace('theLumpDescription', 'theLumpQuantity');
                    break;
                case "theLumpQuantity":
                    focuselmnt = elemenetIdForField.replace('theLumpQuantity', 'theLumpUOM');
                    break;
                case "theLumpUOM":
                    focuselmnt = elemenetIdForField.replace('theLumpUOM', 'theLumpUnitPrice');
                    break;
                case "theLumpUnitPrice":
                    focuselmnt = elemenetIdForField.replace('theLumpUnitPrice', 'theLumpTaxGroup');
                    break;
            }
                

        }

        function setFocus() {
            document.getElementById(focuselmnt).focus();
        }

        /*function validateTaxArea(ctrl) {
                validateTaxArea();
            }

        function validateContacts(ctrl) {
            validateContacts();
        }
            */
        function validateTaxLiable(ctrl) {
            validateTaxLiable();
        }

        function validateSalesOrder(ctrl) {
            validateSalesOrder();
        }

        function validateAltSiteAddress(ctrl) {
            validateAltSiteAddress();
        }

        function setScheduleDate() {
            setScheduleDate();
        }

        //function validateTMCompleted(ctrl) {
        //    validateTMCompleted();
        //}

        function isNumber(evt) {
            evt = (evt) ? evt : window.event;
            var charCode = (evt.which) ? evt.which : evt.keyCode;
            if (charCode > 31 && (charCode < 48 || charCode > 57)) {
                return false;
            }
            return true;
        }

        function insertColon(ctrl, evt) {
            var anc = ctrl;
            //if(ctrl.value.length == 2 && evt.keyCode != 8) {
            //    ctrl.value = ctrl.value + ':';
            //}

            if (ctrl.value.length >= 3 && ctrl.value.indexOf(':') < 0) {
                switch(ctrl.value.length) {
                    case 3:
                        ctrl.value = ctrl.value.substr(0, 2) + ':' + ctrl.value.substr(2, 1);
                        break;
                    default:
                        ctrl.value = ctrl.value.substr(0, 2) + ':' + ctrl.value.substr(2, ctrl.value.length - 2);
                        break;
                }
            }
        }

        function validateStartTime(ctrl) {
            validateStartTime();
        }

        function setWidth() {
            $(".tmLineWrap").css("max-width", (screen.width - 100));
        }
            
        //Ticket# AES-401
        function validateContactCall(field){
            var fieldId = field.id;
            var contactId = document.getElementById(fieldId + "_lkid").value;
            validateContact(fieldId, contactId);
        }
        function validateContractCall(field){
            var fieldId = field.id;
            var contractId = document.getElementById(fieldId + "_lkid").value;
            validateContract(contractId);
        }
            
        // function validatePayRuleCall(field){
        //     var fieldId = field.id;
        //     var payRuleId = document.getElementById(fieldId + "_lkid").value;
        //     validatePayRule(payRuleId);
        // }

        function validateRateSheetCall(field){
            var fieldId = field.id;
            var rateSheetId = document.getElementById(fieldId + "_lkid").value;
            validateRateSheet(rateSheetId);
        }

    </script>
    <c:LoadingStatus />
    <apex:sectionHeader title="T&M" subtitle="{!TM__c.Name}"/>
    <apex:form id="theForm">
        <apex:pageBlock id="thePageBlock">
            <apex:pageMessages id="theMessage"></apex:pageMessages>
            <apex:pageBlockButtons >
                <apex:commandButton value="Save" rendered="{!!afterInvoiced}" action="{!save}" rerender="theForm" status="loadingstatus"/>
                <apex:commandButton value="Save & Change to {!NextStatus}" rendered="{!TMStatus =='Open' || TMStatus == 'Mobile Review' || TMStatus =='Scheduled' || TMStatus =='Confirmed' || TMStatus =='Received By Billing'}" action="{!saveAndChangeStatus}" rerender="theForm" status="loadingstatus"/>
                <apex:commandButton value="Quick Save" rendered="{!!afterInvoiced}" action="{!quicksave}" rerender="theForm" status="loadingstatus"/>
                <apex:commandButton value="Cancel" action="{!cancel}" rerender="theForm" status="loadingstatus"/>
            </apex:pageBlockButtons>
            <apex:actionFunction name="validateTaxArea" action="{!validateTaxArea}" reRender="thePageBlock"
                                 immediate="false" status="loadingstatus">
                <apex:param value="" name="fieldName"/>
                <apex:param value="" name="newFieldValue"/>
                <apex:param value="" name="lineNo"/>
            </apex:actionFunction>
            <apex:actionFunction name="validateSalespeopleFunc" action="{!validateSalespeople}"
                                 reRender="thePageBlockSection-JI, theServiceCenterPageSection" immediate="false"
                                 status="loadingstatus"/>
            <apex:actionFunction name="validateServiceCenterFunc" action="{!validateServiceCenter}"
                                 reRender="thePageBlock" immediate="false" status="loadingstatus"/>
            <apex:actionFunction name="validateTaxLiable" action="{!validateTaxLiable}" reRender="thePageBlock"
                                 immediate="false" status="loadingstatus"/>
            <apex:actionFunction name="validateAltSiteAddress" action="{!validateAltSiteAddress}"
                                 reRender="thePageBlock" immediate="false" status="loadingstatus"/>
            <apex:actionFunction name="validateStartTime" action="{!validateStartTime}" reRender="thePageBlock"
                                 immediate="false" status="loadingstatus"/>
            <apex:actionFunction name="setScheduleDate" action="{!setScheduleDate}" oncomplete="setWidth();" reRender="theEquipmentSection, theTMLEquipmentTable"
                                 immediate="false" status="loadingstatus"/>

            <apex:actionFunction name="validateField" action="{!validateField}" oncomplete="setWidth();setFocus();"
                                 reRender="thePageBlock,theLaborSection,theMaterialsSection,theEquipmentSection,theSubcontractorsSection,
                                 theFieldRemediationSection, theWasteDisposalSection, theDemurrageSection, theLumpSumSection, theMiscSection, theMessage,theMessage2"
                                 immediate="false" status="loadingstatus">
                <apex:param value="" name="fieldName"/>
                <apex:param value="" name="newFieldValue"/>
                <apex:param value="" name="lineNo"/>
            </apex:actionFunction>

            <apex:actionFunction name="validateSalesOrder" action="{!validateSalesOrder}" reRender="thePageBlock"
                                 immediate="false" status="loadingstatus"/>

            <apex:actionFunction name="validateContact" action="{!validateContact}" reRender="thePageBlockSection-CI,thePageBlockSection-SI"
                                 immediate="false" status="loadingstatus">
                <apex:param value="" name="fieldId"/>
                <apex:param value="" name="contactId"/>
            </apex:actionFunction>

            <apex:actionFunction name="validateContract" action="{!validateContract}" reRender="thePageBlockSection"
                                 immediate="false" status="loadingstatus">
                <apex:param value="" name="contractId"/>
            </apex:actionFunction>

            <apex:actionFunction name="validateRateSheet" action="{!validateRateSheet}"  reRender="thePageBlock,theLaborSection,theMaterialsSection,theEquipmentSection,theSubcontractorsSection,
                                 theFieldRemediationSection, theWasteDisposalSection, theDemurrageSection, theLumpSumSection, theMiscSection, theMessage,theMessage2"
                                 immediate="false" status="loadingstatus">
                <apex:param value="" name="rateSheetId"/>
            </apex:actionFunction>
            <apex:pageBlockSection title="TM Information" collapsible="true" id="thePageBlockSection">
                <apex:outputField value="{!TM.Name}"/>
                <apex:outputField value="{!TM.Status__c}"/>

                <apex:inputField onchange="validateSalesOrder(this);" rendered="{!theUser.Super_User__c == true && TM.Emergency_TM__c != true}"
                                 value="{!TM.Sales_Order__c}"/>

                <apex:pageBlockSectionItem rendered="{!TM.Emergency_TM__c == true}">
                    <apex:outputLabel >Sales Order</apex:outputLabel>
                    <apex:outputpanel >
                        <apex:panelGrid columns="3" cellspacing="1" style="margin-left:00px;">
                            <c:CustomLookup componentId="theSalesOrder"
                                            styleClass="input-lookup"
                                            style="width: 150px; height:18px;"
                                            filterClause="Sales_Order_Type__r.Emergency_Response__c = true AND Service_Center__c = \'{!TM.Service_Center__c}\' AND Document_Status__c = \'Open\' AND Document_Type__c = \'Sales Order\'"
                                            useSOSL="false"
                                            minSearchLength="1"
                                            sObjectType="TM__c"
                                            sObject="{!TM}"
                                            sObjectField="Sales_Order__c"
                                            onchange="validateSalesOrder(this);"

                                            allowtoBlank="true"
                                            LookupObject="Sales_Order__c"
                                            LinkFieldName="Id"
                                            FieldSetName="SalesOrderFieldSet"
                                            RunValidation="True"
                                            LookupType="Id"
                                            ValidateFunction="validateSalesOrder"

                                            FilterName1="Sales_Order_Type__r.Emergency_Response__c"
                                            FilterNameValue1="true"
                                            FilterOperation1="Sales_Order_Type__r.Emergency_Response__c"
                                            FilterOperationValue1="="
                                            FilterType1="Sales_Order_Type__r.Emergency_Response__c"
                                            FilterTypeValue1="Boolean"

                                            FilterName2="Service_Center__c"
                                            FilterNameValue2="{!TM.Service_Center__c}"
                                            FilterOperation2="Service_Center__c"
                                            FilterOperationValue2="="
                                            FilterType2="Service_Center__c"
                                            FilterTypeValue2="String"

                                            FilterName3="Document_Status__c"
                                            FilterNameValue3="Open"
                                            FilterOperation3="Document_Status__c"
                                            FilterOperationValue3="="
                                            FilterType3="Document_Status__c"
                                            FilterTypeValue3="String"

                                            FilterName4="Document_Type__c"
                                            FilterNameValue4="Sales Order"
                                            FilterOperation4="Document_Type__c"
                                            FilterOperationValue4="="
                                            FilterType4="Document_Type__c"
                                            FilterTypeValue4="String"

                                            fltr1="true"
                                            fltr2="true"
                                            fltr3="true"
                                            fltr4="true"
                                            fltr5="true"
                                            fltr6="true"
                                            fltr7="true"
                            />
                        </apex:panelGrid>
                    </apex:outputpanel>
                </apex:pageBlockSectionItem>
                <apex:outputField rendered="{!theUser.Super_User__c == false && TM.Emergency_TM__c != true}" value="{!TM.Sales_Order__c}"/>

                <apex:pageBlockSectionItem rendered="{!!afterInvoiced}">
                    <apex:outputLabel >Contract</apex:outputLabel>
                    <apex:outputpanel >
                        <apex:panelGrid columns="3" cellspacing="1" style="margin-left:00px;">
                            <c:CustomLookup componentId="theContract"
                                            styleClass="input-lookup"
                                            style="width: 150px; height:18px;"
                                            useSOSL="false"
                                            minSearchLength="1"
                                            sObjectType="Contract"
                                            secondaryDisplayField=""
                                            sObject="{!theContract}"
                                            sObjectField="ContractNumber"
                                            SObjectTypeSearch="Name"
                                            onchange="validateContractCall(this);"
                                            LookupObject="Contract"
                                            LinkFieldName="Id"
                                            FieldSetName="ContractFieldSet"
                                            RunValidation="True"
                                            LookupType="Id"

                                            ValidateFunction="validateFieldInList"

                                            FilterName1Special="AccountId"
                                            FilterNameValue1Special="{!TM.Bill_to_Customer__c+','+TM.Bill_to_Customer__r.ParentId}"
                                            FilterOperation1Special="AccountId"
                                            FilterOperationValue1Special="="
                                            FilterType1Special="AccountId"
                                            FilterTypeValue1Special="string"

                                            calledFrom="SalesOrder"
                                            calledFor="ContractLookUp"
                                            isSpecialScenario="true"

                                            fltr1="true"
                                            fltr2="true"
                                            fltr3="true"
                                            fltr4="true"
                                            fltr5="true"
                                            fltr6="true"
                                            fltr7="true"
                            />
                        </apex:panelGrid>
                    </apex:outputpanel>
                </apex:pageBlockSectionItem>
                <apex:outputField value="{!TM.Contract__c}" rendered="{!afterInvoiced}"/>

                <apex:inputField value="{!TM.From_Sales_Quote__c}" rendered="{!!afterInvoiced}"/>
                <apex:outputField value="{!TM.From_Sales_Quote__c}" rendered="{!afterInvoiced}"/>

                <apex:outputField value="{!TM.Contract_Name__c}" />

                <apex:pageBlockSectionItem >
                    <apex:outputLabel >Rate Sheet</apex:outputLabel>
                    <apex:outputpanel >
                        <apex:panelGrid columns="3" cellspacing="1" style="margin-left:00px;">
                            <c:CustomLookup componentId="theRateSheet"
                                            styleClass="input-lookup"
                                            style="width: 150px; height:18px;"
                                            useSOSL="false"
                                            minSearchLength="1"
                                            secondaryDisplayField="Name"
                                            sObjectType="TM__c"
                                            sObject="{!TM}"
                                            sObjectField="Rate_Sheet__c"
                                            onchange="validateRateSheetCall(this);"

                                            allowtoBlank="true"
                                            LookupObject="Rate_Sheet__c"
                                            LinkFieldName="Id"
                                            FieldSetName="RateSheetFieldSet"
                                            RunValidation="True"
                                            LookupType="Id"
                                            ValidateFunction="validateRateSheetCall"

                                            fltr1="true"
                                            fltr2="true"
                                            fltr3="true"
                                            fltr4="true"
                                            fltr5="true"
                                            fltr6="true"
                                            fltr7="true"
                            />
                        </apex:panelGrid>
                    </apex:outputpanel>
                </apex:pageBlockSectionItem>

            </apex:pageBlockSection>
            <apex:pageBlockSection title="Customer Information" collapsible="true" id="thePageBlockSection-CI">
                <apex:outputField value="{!TM.Bill_to_Customer__c}"/>

                <apex:pageBlockSectionItem rendered="{!!afterInvoiced}" id="theBTContactPBSI">
                    <apex:outputLabel >Contact</apex:outputLabel>
                    <apex:outputpanel >
                        <apex:panelGrid columns="3" cellspacing="1" style="margin-left:00px;">
                            <c:CustomLookup componentId="theBTContact"
                                            styleClass="input-lookup"
                                            style="width: 150px; height:18px;"
                                            filterClause="Contact_Type__c INCLUDES {!TM.Bill_to_Customer__r.Contact_Type_Filter__c} AND AccountId = \'{!TM.Bill_to_Customer__c}\'"
                                            useSOSL="false"
                                            minSearchLength="1"
                                            secondaryDisplayField="LastName"
                                            sObjectType="TM__c"
                                            sObject="{!TM}"
                                            sObjectField="Contact__c"
                                            onchange="validateContactCall(this);"

                                            allowtoBlank="true"
                                            LookupObject="Contact"
                                            LinkFieldName="Id"
                                            LookupType="Id"
                                            FieldSetName="ContactFieldSet"
                                            RunValidation="True"
                                            ValidateFunction="validateContactCall"

                                            FilterName1="AccountId"
                                            FilterNameValue1="{!TM.Bill_to_Customer__c}"
                                            FilterOperation1="AccountId"
                                            FilterOperationValue1="="
                                            FilterType1="AccountId"
                                            FilterTypeValue1="String"

                                            FilterName2="Contact_Type__c"
                                            FilterNameValue2="Billing"
                                            FilterOperation2="Contact_Type__c"
                                            FilterOperationValue2="INCLUDES"
                                            FilterType2="Contact_Type__c"
                                            FilterTypeValue2="Includes"

                                            fltr1="true"
                                            fltr2="true"
                                            fltr3="true"
                                            fltr4="true"
                                            fltr5="true"
                                            fltr6="true"
                                            fltr7="true"
                            />
                        </apex:panelGrid>
                    </apex:outputpanel>
                </apex:pageBlockSectionItem>
                <apex:outputField value="{!TM.Contact__c}" rendered="{!afterInvoiced}"/>
            </apex:pageBlockSection>
            <apex:pageBlockSection title="Sales Order Information" collapsible="true" id="thePageBlockSection-JI">
                <apex:outputField value="{!TM.Service_Center__c}"/>
                <apex:inputField value="{!TM.Desired_Scheduled_Date__c}" rendered="{!!afterInvoiced}"/>
                <apex:outputField value="{!TM.Desired_Scheduled_Date__c}" rendered="{!afterInvoiced}"/>
                <apex:outputField value="{!TM.Subsidiary_Company__c}"/>
                <apex:inputField value="{!TM.Scheduled_Date__c}" onchange="setScheduleDate();" rendered="{!!afterInvoiced}"/>
                <apex:outputField value="{!TM.Scheduled_Date__c}" rendered="{!afterInvoiced}"/>
                <apex:outputField value="{!TM.Prevailing_Wage_Job__c}"/>
                <apex:inputField onchange="validateStartTime(this);" value="{!TM.Start_Time__c}" onkeyup="insertColon(this, event);"
                                 onkeypress="return isNumber(event);" rendered="{!!afterInvoiced}"/>
                <apex:outputField value="{!TM.Start_Time__c}" rendered="{!afterInvoiced}"/>
                <apex:outputField value="{!TM.Certified_PW_Job__c}"/>
                <apex:inputField value="{!TM.Day_of_Job__c}" rendered="{!!afterInvoiced}"/>
                <apex:outputField value="{!TM.Day_of_Job__c}" rendered="{!afterInvoiced}"/>
                <apex:outputField value="{!TM.Account_Executive__c}"/>
                <apex:outputField value="{!TM.Lump_Sum_Order__c}"/>
                <apex:inputField value="{!TM.Project_Coordinator__c}" rendered="{!!afterInvoiced}"/>
                <apex:outputField value="{!TM.Project_Coordinator__c}" rendered="{!afterInvoiced}"/>
                <apex:outputField value="{!TM.Customer_PO_No__c}"/>
            </apex:pageBlockSection>

            <apex:pageBlockSection title="Site Information" collapsible="true" id="thePageBlockSection-SI">

                <apex:inputField value="{!TM.Alternate_Site_Address__c}" onchange="validateAltSiteAddress(this)"/>

                <apex:pageBlockSectionItem >
                    <apex:outputLabel >Site Contact</apex:outputLabel>
                    <apex:outputpanel >
                        <apex:panelGrid columns="3" cellspacing="1" style="margin-left:00px;">
                            <c:CustomLookup componentId="theSiteContact"
                                            styleClass="input-lookup" style="width: 150px; height:18px;" useSOSL="false"
                                            minSearchLength="1"
                                            filterClause="Contact_Type__c=\'Billing\'"
                                            sObjectType="Contact"
                                            sObject="{!theSiteContact}"
                                            sObjectField="Name"
                                            SObjectTypeSearch="Contact"
                                            secondaryDisplayField="LastName"
                                            onchange="validateContactCall(this);"
                                            LookupObject="Contact"
                                            LinkFieldName="Id"
                                            FieldSetName="ContactFieldSet"
                                            RunValidation="True"
                                            LookupType="Id"

                                            ValidateFunction="validateFieldInList"

                                            FilterName1="AccountId"
                                            FilterNameValue1="{!TM.Bill_to_Customer__c}"
                                            FilterOperation1="AccountId"
                                            FilterOperationValue1="="
                                            FilterType1="AccountId"
                                            FilterTypeValue1="String"

                                            FilterName2="Contact_Type__c"
                                            FilterNameValue2="Site"
                                            FilterOperation2="Contact_Type__c"
                                            FilterOperationValue2="INCLUDES"
                                            FilterType2="Contact_Type__c"
                                            FilterTypeValue2="Includes"

                                            fltr1="true"
                                            fltr2="true"
                                            fltr3="true"
                                            fltr4="true"
                                            fltr5="true"
                                            fltr6="true"
                                            fltr7="true"
                            />
                        </apex:panelGrid>
                    </apex:outputpanel>
                </apex:pageBlockSectionItem>

                <apex:inputField value="{!TM.Site_Name__c}"
                                 rendered="{!TM.Alternate_Site_Address__c == null || TM.Alternate_Site_Address__c == ''}"/>
                <apex:outputField value="{!TM.Site_Name__c}"
                                  rendered="{!TM.Alternate_Site_Address__c != null && TM.Alternate_Site_Address__c != ''}"/>

                <apex:inputField value="{!TM.Site_Phone_No__c}"
                                 rendered="{!TM.Alternate_Site_Address__c == null || TM.Alternate_Site_Address__c == ''}"/>
                <apex:outputField value="{!TM.Site_Phone_No__c}"
                                  rendered="{!TM.Alternate_Site_Address__c != null && TM.Alternate_Site_Address__c != ''}"/>

                <apex:inputField value="{!TM.Site_Street__c}"
                                 rendered="{!TM.Alternate_Site_Address__c == null || TM.Alternate_Site_Address__c == ''}"/>
                <apex:outputField value="{!TM.Site_Street__c}"
                                  rendered="{!TM.Alternate_Site_Address__c != null && TM.Alternate_Site_Address__c != ''}"/>

                <apex:inputField value="{!TM.Site_Email_Address__c}"/>                

                <apex:inputField value="{!TM.Site_City__c}"
                                 rendered="{!TM.Alternate_Site_Address__c == null || TM.Alternate_Site_Address__c == ''}"/>
                <apex:outputField value="{!TM.Site_City__c}"
                                  rendered="{!TM.Alternate_Site_Address__c != null && TM.Alternate_Site_Address__c != ''}"/>

                <apex:inputField value="{!TM.Create_Site_Address__c}"
                                 rendered="{!TM.Alternate_Site_Address__c == null || TM.Alternate_Site_Address__c == ''}"/>
                <apex:outputField value="{!TM.Create_Site_Address__c}"
                                  rendered="{!TM.Alternate_Site_Address__c != null && TM.Alternate_Site_Address__c != ''}"/>

                <apex:inputField value="{!TM.Site_State__c}"
                                 rendered="{!TM.Alternate_Site_Address__c == null || TM.Alternate_Site_Address__c == ''}"/>
                <apex:outputField value="{!TM.Site_State__c}"
                                  rendered="{!TM.Alternate_Site_Address__c != null && TM.Alternate_Site_Address__c != ''}"/>

                <apex:inputField value="{!TM.Print_Site_Name__c}"
                                 rendered="{!TM.Alternate_Site_Address__c == null || TM.Alternate_Site_Address__c == ''}"/>
                <apex:outputField value="{!TM.Print_Site_Name__c}"
                                  rendered="{!TM.Alternate_Site_Address__c != null && TM.Alternate_Site_Address__c != ''}"/>

                <apex:inputField value="{!TM.Site_Postal_Code__c}"
                                 rendered="{!TM.Alternate_Site_Address__c == null || TM.Alternate_Site_Address__c == ''}"/>
                <apex:outputField value="{!TM.Site_Postal_Code__c}"
                                  rendered="{!TM.Alternate_Site_Address__c != null && TM.Alternate_Site_Address__c != ''}"/>

                <apex:inputField rendered="{!afterConfirmed}"
                                 value="{!TM.Tax_Liable__c}" onchange="validateTaxLiable(this);"/>
                <apex:outputField rendered="{!!afterConfirmed}" value="{!TM.Tax_Liable__c}" />

                <apex:inputField value="{!TM.Site_Country__c}"
                                 rendered="{!TM.Alternate_Site_Address__c == null || TM.Alternate_Site_Address__c == ''}"/>
                <apex:outputField value="{!TM.Site_Country__c}"
                                  rendered="{!TM.Alternate_Site_Address__c != null && TM.Alternate_Site_Address__c != ''}"/>

                <apex:pageBlockSectionItem id="ta">
                    <apex:outputLabel >Tax Area</apex:outputLabel>
                    <apex:outputPanel id="theTA">
                        <apex:panelGrid columns="3" cellspacing="1" style="margin-left:00px;" id="LPNL">
                            <c:CustomLookup componentId="{!$Component.thePLTable}:theTaxArea"
                                            styleClass="input-lookup" style="width: 200px" useSOSL="false"
                                            minSearchLength="1"
                                            filterClause="Blocked__c <> true"
                                            secondaryDisplayField="Description__c"
                                            onchange="validateFieldInList(this);"

                                            sObjectType="TM__c"
                                            sObject="{!TM}"
                                            sObjectField="Tax_Area__c"

                                            LookupObject="Tax_Area__c"
                                            LookupType="Id"
                                            LinkFieldName="Id"
                                            FieldSetName="TaxAreaFieldSet"
                                            RunValidation="True"

                                            ValidateFunction="validateFieldInList"

                                            FilterName1="Blocked__c"
                                            FilterNameValue1="false"
                                            FilterOperation1="Blocked__c"
                                            FilterOperationValue1="="
                                            FilterType1="Blocked__c"
                                            FilterTypeValue1="Boolean"
                                            
                                            fltr1="true"
                                            fltr2="true"
                                            fltr3="true"
                                            fltr4="true"
                                            fltr5="true"
                                            fltr6="true"
                                            fltr7="true"
                            />
                        </apex:panelGrid>
                    </apex:outputPanel>
                </apex:pageBlockSectionItem>

            </apex:pageBlockSection>
            <apex:pageBlockSection title="Instructions" collapsible="true" id="thePageBlockSectionScope">

                <apex:pageBlockSectionItem >
                    <apex:outputLabel >{!$ObjectType.TM__c.Fields.Site_Scope__c.Label}</apex:outputLabel>
                    <apex:outputpanel >
                <div class="requiredInput">
                    <div class="requiredBlock"></div>
                    <apex:inputField value="{!TM.Site_Scope__c}" style="width:100%; height: 60px"/>
                </div>
                    </apex:outputpanel>
                </apex:pageBlockSectionItem>

                <apex:pageBlockSectionItem />
                <apex:inputField value="{!TM.Internal_Comments__c}" style="width:100%; height: 60px"/>
                <apex:pageBlockSectionItem />
                <apex:inputField label="Job Log" value="{!TM.Customer_Comments__c}" style="width:100%; height: 60px"/>                
                <apex:pageBlockSectionItem />
                <apex:outputField value="{!TM.Sales_Order_Instructions__c}" style="width:100%; height: 60px"/>
                <apex:pageBlockSectionItem />
                <apex:outputField label="Customer Billing Instructions" value="{!TM.Customer_Billing_Instructions__c}" style="width:100%; height: 60px" />
                <apex:pageBlockSectionItem />
            </apex:pageBlockSection>
            <apex:pageMessages id="theMessage2"></apex:pageMessages>

            <apex:pageBlockSection id="theLaborSection" columns="1" title="Labor Lines" collapsible="true">

                <apex:outputPanel styleClass="tmLineWrap" layout="block">
                    <apex:pageBlockTable id="theTMLLaborTable" value="{!TMLListLabor}" var="line"
                                         rendered="{!NOT(ISNULL(TMLListLabor))}">
                        <apex:column headerValue="Action" styleClass="actionColumn" style="width:60px">
                            <apex:commandButton value="Delete" disabled="{!afterConfirmed && NOT(line.Service_Center__r.Temporary__c)}" onclick="if(!confirmDelete()){return false};"
                                                oncomplete="setWidth();" action="{!deleteLine}"
                                                reRender="theTMLLaborTable">
                                <apex:param id="objectType" name="objectType" value="TMLine"/>
                                <apex:param id="displayId" name="displayId" value="{!line.Line_No__c}"/>
                                <apex:param id="lineType" name="lineType" value="Labor"/>
                            </apex:commandButton>


                            <apex:commandButton value="Copy Time" disabled="{!afterConfirmed}" onclick="if(!confirmCopyTime('Labor')){return false};"
                                                oncomplete="setWidth();" action="{!copyTime}"
                                                reRender="theTMLLaborTable, theMessage, theMessage2"
                                                rendered="{!NOT(afterConfirmed)}">
                                <apex:param id="objectTypeCopy" name="objectType" value="TMLine"/>
                                <apex:param id="displayIdCopy" name="displayId" value="{!line.Line_No__c}"/>
                                <apex:param id="lineTypeCopy" name="lineType" value="Labor"/>
                            </apex:commandButton>

                            <apex:commandButton value="Copy Billing Time" disabled="{!NOT(afterConfirmed)}" onclick="if(!confirmCopyTime('Labor')){return false};"
                                                oncomplete="setWidth();" action="{!copyTime}"
                                                reRender="theTMLLaborTable, theMessage, theMessage2"
                                                rendered="{!afterConfirmed}">
                                <apex:param id="objectTypeCopy_bill" name="objectType" value="TMLine"/>
                                <apex:param id="displayIdCopy_bill" name="displayId" value="{!line.Line_No__c}"/>
                                <apex:param id="lineTypeCopy_bill" name="lineType" value="Labor"/>
                                <apex:param id="timeTypeCopy_bill" name="timeType" value="BillingTime" />
                            </apex:commandButton>

                        </apex:column>
                        <apex:column headerValue="Labor Type">

                            <apex:outputpanel >
                                <div class="requiredInput">
                                    <div class="requiredBlock"></div>
                                    <c:CustomLookup componentId="{!$Component.theTMLLaborTable}:theJobPosition"
                                                    styleClass="input-lookup"
                                                    style="width: 100px"
                                                    filterClause="Blocked__c=false AND Category__c = \'Labor\'"
                                                    secondaryDisplayField="Description__c"
                                                    minSearchLength="1"
                                                    stealFocus="true"
                                                    sObjectType="TM_Line__c"
                                                    sObject="{!line}"
                                                    sObjectField="Resource_Type__c"
                                                    onchange="validateFieldInList(this);"

                                                    allowtoBlank="true"
                                                    LookupObject="Resource_Type__c"
                                                    LinkFieldName="Name"
                                                    FieldSetName="ResourceTypeFieldSet"
                                                    RunValidation="True"
                                                    LookupType="ID"
                                                    ValidateFunction="validateField"

                                                    FilterName1="Category__c"
                                                    FilterNameValue1="Labor"
                                                    FilterOperation1="Category__c"
                                                    FilterOperationValue1="="
                                                    FilterType1="Category__c"
                                                    FilterTypeValue1="String"

                                                    FilterName2="Blocked__c"
                                                    FilterNameValue2="false"
                                                    FilterOperation2="Blocked__c"
                                                    FilterOperationValue2="="
                                                    FilterType2="Blocked__c"
                                                    FilterTypeValue2="Boolean"

                                                    fltr1="true"
                                                    fltr2="true"
                                                    fltr3="true"
                                                    fltr4="true"
                                                    fltr5="true"
                                                    fltr6="true"
                                                    fltr7="true"/>
                                </div>
                            </apex:outputpanel>
                        </apex:column>
                        <apex:column headerValue="SC">
                            <apex:outputpanel rendered="{!!afterConfirmed || line.Service_Center__r.Temporary__c}">
                                <div class="requiredInput">
                                    <div class="requiredBlock"></div>
                                    <c:CustomLookup componentId="{!$Component.theTMLLaborTable}:theServiceCenter"
                                                    styleClass="input-lookup"
                                                    style="width: 50px"
                                                    secondaryDisplayField="Description__c"
                                                    minSearchLength="1"
                                                    stealFocus="true"
                                                    sObjectType="TM_Line__c"
                                                    sObject="{!line}"
                                                    sObjectField="Service_Center__c"
                                                    onchange="validateFieldInList(this);"

                                                    allowtoBlank="true"
                                                    LookupObject="Service_Center__c"
                                                    LinkFieldName="Name"
                                                    FieldSetName="ServiceCenterFieldSet"
                                                    RunValidation="True"
                                                    LookupType="ID"
                                                    ValidateFunction="validateField"

                                                    fltr1="true"
                                                    fltr2="true"
                                                    fltr3="true"
                                                    fltr4="true"
                                                    fltr5="true"
                                                    fltr6="true"
                                                    fltr7="true"/>
                                </div>
                            </apex:outputpanel>
                            <apex:outputField value="{!line.Service_Center__c}" rendered="{!afterConfirmed && NOT(line.Service_Center__r.Temporary__c)}"/>
                        </apex:column>
                        <apex:column headerValue="Labor">
                            <apex:outputpanel rendered="{!!afterConfirmed || line.Service_Center__r.Temporary__c}">
                                <div class="requiredInput">
                                    <div class="requiredBlock"></div>
                                    <c:CustomLookup componentId="{!$Component.theTMLLaborTable}:theLResource"
                                                    styleClass="input-lookup"
                                                    style="width: 100px"
                                                    filterClause="Category__c = \'Labor\' AND (Start_Date__c = null OR
                                                        Start_Date__c <= {!scheduledatefilterFormat}) AND
                                                        (End_Date__c = null OR End_Date__c >= {!scheduledatefilterFormat})"
                                                    secondaryDisplayField="Description__c"
                                                    minSearchLength="1"
                                                    stealFocus="true"
                                                    sObjectType="TM_Line__c"
                                                    sObject="{!line}"
                                                    sObjectField="Resource__c"
                                                    onchange="validateFieldInList(this);"

                                                    allowtoBlank="true"
                                                    LookupObject="Resource__c"
                                                    LinkFieldName="Name"
                                                    FieldSetName="ResourceFieldSet"
                                                    RunValidation="True"
                                                    LookupType="ID"
                                                    ValidateFunction="validateField"

                                                    FilterName1="Category__c"
                                                    FilterNameValue1="Labor"
                                                    FilterOperation1="Category__c"
                                                    FilterOperationValue1="="
                                                    FilterType1="Category__c"
                                                    FilterTypeValue1="String"

                                                    FilterName3="Resource_Type__c"
                                                    FilterNameValue3="{!line.Resource_Type__c}"
                                                    FilterOperation3="Resource_Type__c"
                                                    FilterOperationValue3="="
                                                    FilterType3="Resource_Type__c"
                                                    FilterTypeValue3="String"

                                                    FilterName4="Service_Center__c"
                                                    FilterNameValue4="{!line.Service_Center__c}"
                                                    FilterOperation4="Service_Center__c"
                                                    FilterOperationValue4="="
                                                    FilterType4="Service_Center__c"
                                                    FilterTypeValue4="String"

                                                    FilterName1Special="ScheduleDate"
                                                    FilterNameValue1Special="{!scheduledDateValue}"
                                                    FilterOperation1Special="ScheduleDate"
                                                    FilterOperationValue1Special="<="
                                                    FilterType1Special="ScheduleDate"
                                                    FilterTypeValue1Special="Date"

                                                    calledFrom="TM"
                                                    calledFor="LaborResourceLookup"
                                                    isSpecialScenario="true"

                                                    fltr1="true"
                                                    fltr2="true"
                                                    fltr3="true"
                                                    fltr4="true"
                                                    fltr5="true"
                                                    fltr6="true"
                                                    fltr7="true"/>
                                </div>
                            </apex:outputpanel>
                            <apex:outputField value="{!line.Resource__c}" rendered="{!afterConfirmed && NOT(line.Service_Center__r.Temporary__c)}"/>
                        </apex:column>

                        <apex:column headerValue="Labor Name">
                            <apex:inputField id="theResourceName" value="{!line.Resource_Name__c}" rendered="{!line.Resource__r.Employee_No__c == null}"/>
                            <apex:outputText value="{!line.Resource_Name__c}" rendered="{!line.Resource__r.Employee_No__c != null}" />
                        </apex:column>

                        <apex:column headerValue="{!$ObjectType.TM_Line__c.fields.Description__c.Label}">
                            <apex:inputField id="theDescription" value="{!line.Description__c}"/>
                        </apex:column>

                        <apex:column headerValue="Dispatch from Home" rendered="{!TM.Sales_Order__r.Distance_to_Job_Site__c != null}">
                            <apex:inputField id="laborDispatchFromHome" value="{!line.Eligible_Dispatch_from_Home_Pay__c}" onchange="validateFieldInList(this);"/>
                        </apex:column>
                        
                        <apex:column rendered="{!afterConfirmed}" headerValue="{!$ObjectType.TM_Line__c.fields.Bill_Site_Time__c.Label}">
                            <apex:inputField id="theBillSiteTime" value="{!line.Bill_Site_Time__c}" onchange="validateFieldInList(this);"/>
                        </apex:column>

                        <apex:column rendered="{!afterConfirmed}"
                                     headerValue="{!$ObjectType.TM_Line__c.fields.Include_Lunch_Y_N__c.Label}">
                            <apex:inputField id="theInclLunchYN" value="{!line.Include_Lunch_Y_N__c}" onChange="validateFieldInList(this)"/>
                        </apex:column>

                        <apex:column rendered="{!afterConfirmed}"
                                     headerValue="{!$ObjectType.TM_Line__c.fields.Billing_Start_Time__c.Label}">
                            <apex:inputField id="theBillingStartTime"
                                             onkeyup="insertColon(this, event);"
                                             onkeypress="return isNumber(event);"
                                             value="{!line.Billing_Start_Time__c}" onchange="validateFieldInList(this);"/>
                        </apex:column>
                        <apex:column rendered="{!afterConfirmed}"
                                     headerValue="{!$ObjectType.TM_Line__c.fields.Billing_End_Time__c.Label}">
                            <apex:inputField id="theBillingEndTime" 
                                             onkeyup="insertColon(this, event);"
                                             onkeypress="return isNumber(event);"
                                             value="{!line.Billing_End_Time__c}" onchange="validateFieldInList(this);"/>
                        </apex:column>
                        <apex:column rendered="{!afterConfirmed}"
                                     headerValue="{!$ObjectType.TM_Line__c.fields.Hour__c.Label}">
                            <apex:outputField id="theHour" value="{!line.Hour__c}" style="width:60px"/>
                        </apex:column>
                        <apex:column rendered="{!afterConfirmed}"
                                     headerValue="{!$ObjectType.TM_Line__c.fields.Quantity__c.Label}">

                            <apex:inputField id="theLQuantity" onchange="validateFieldInList(this);" value="{!line.Quantity__c}" style="width:60px"
                                             styleClass="input-numeric"/>
                        </apex:column>
                        <apex:column rendered="{!afterConfirmed}" headerValue="{!$ObjectType.TM_Line__c.fields.Unit_of_Measure__c.Label}">
                            <apex:outputpanel >
                                <div class="requiredInput">
                                    <div class="requiredBlock"></div>
                                    <c:CustomLookup componentId="{!$Component.theTMLLaborTable}:theLUOM"
                                                    styleClass="input-lookup"
                                                    style="width: 100px"
                                                    secondaryDisplayField="Description__c"
                                                    minSearchLength="1"
                                                    stealFocus="true"
                                                    sObjectType="TM_Line__c"
                                                    sObject="{!line}"
                                                    sObjectField="Unit_of_Measure__c"
                                                    onchange="validateFieldInList(this);"

                                                    allowtoBlank="true"
                                                    LookupObject="Unit_of_Measure__c"
                                                    LinkFieldName="Name"
                                                    FieldSetName="UOMFieldSet"
                                                    RunValidation="True"
                                                    LookupType="ID"
                                                    ValidateFunction="validateField"

                                                    FilterName1Special="ResourceType"
                                                    FilterNameValue1Special="{!line.Resource_Type__c}"
                                                    FilterOperation1Special="ResourceType"
                                                    FilterOperationValue1Special="="
                                                    FilterType1Special="ResourceType"
                                                    FilterTypeValue1Special="string"

                                                    calledFrom="TM"
                                                    calledFor="ResourceTypeUOMLookup"
                                                    isSpecialScenario="true"

                                                    fltr1="true"
                                                    fltr2="true"
                                                    fltr3="true"
                                                    fltr4="true"
                                                    fltr5="true"
                                                    fltr6="true"
                                                    fltr7="true"
                                    />
                                </div>
                            </apex:outputpanel>
                        </apex:column>

                        <apex:column rendered="{!afterConfirmed}"
                                     headerValue="{!$ObjectType.TM_Line__c.fields.Regular_Hours__c.Label}">
                            <apex:inputField id="theRegularHour" onchange="validateFieldInList(this);"
                                             value="{!line.Regular_Hours__c}"
                                             rendered="{!(theTM.Contract__c != null && theTM.Billing_Rule_Id__c == null) || theTM.Sales_Order__r.Billing_Rule_Not_Required__c == true}"/>
                            <apex:outputField style="width:60px"
                                              value="{!line.Regular_Hours__c}"
                                              rendered="{!(theTM.Contract__c == null || theTM.Billing_Rule_Id__c != null) && theTM.Sales_Order__r.Billing_Rule_Not_Required__c != true}"/>
                        </apex:column>
                        <apex:column rendered="{!afterConfirmed}"
                                     headerValue="{!$ObjectType.TM_Line__c.fields.Overtime_Hours__c.Label}">
                            <apex:inputField id="theOvertimeHour" onchange="validateFieldInList(this);"
                                             value="{!line.Overtime_Hours__c}"
                                             rendered="{!(theTM.Contract__c != null && theTM.Billing_Rule_Id__c == null) || theTM.Sales_Order__r.Billing_Rule_Not_Required__c == true}"/>
                            <apex:outputField style="width:60px" value="{!line.Overtime_Hours__c}"
                                              rendered="{!(theTM.Contract__c == null || theTM.Billing_Rule_Id__c != null) && theTM.Sales_Order__r.Billing_Rule_Not_Required__c != true}"/>
                        </apex:column>

                        <apex:column rendered="{!afterConfirmed}"
                                     headerValue="{!$ObjectType.TM_Line__c.fields.Premium_Hours__c.Label}">
                            <apex:inputField id="thePremiumHours" onchange="validateFieldInList(this);"
                                             value="{!line.Premium_Hours__c}"
                                             rendered="{!(theTM.Contract__c != null && theTM.Billing_Rule_Id__c == null) || theTM.Sales_Order__r.Billing_Rule_Not_Required__c == true}"/>
                            <apex:outputField style="width:60px" value="{!line.Premium_Hours__c}"
                                              rendered="{!(theTM.Contract__c == null || theTM.Billing_Rule_Id__c != null) && theTM.Sales_Order__r.Billing_Rule_Not_Required__c != true}"/>
                        </apex:column>

                        <apex:column rendered="{!afterConfirmed}" headerValue="{!$ObjectType.TM_Line__c.fields.Bill_as_Lump_Sum__c.Label}">
                            <apex:inputField id="theLBillasLumpSum" value="{!line.Bill_as_Lump_Sum__c}" onchange="validateFieldInList(this);"/>
                        </apex:column>
                        <apex:column rendered="{!afterConfirmed}" headerValue="{!$ObjectType.TM_Line__c.fields.Non_Billable__c.Label}">
                            <apex:inputField id="theLNonBillable" value="{!line.Non_Billable__c}" onchange="validateFieldInList(this);"/>
                        </apex:column>

                        <apex:column rendered="{!afterConfirmed}"
                                     headerValue="{!$ObjectType.TM_Line__c.fields.Regular_Rate__c.Label}">
                            <apex:inputField id="theRegularRate" onchange="validateFieldInList(this);"
                                             value="{!line.Regular_Rate__c}"/>
                        </apex:column>

                        <apex:column rendered="{!afterConfirmed}"
                                     headerValue="{!$ObjectType.TM_Line__c.fields.Overtime_Rate__c.Label}">
                            <apex:inputField id="theOvertimeRate" onchange="validateFieldInList(this);"
                                             value="{!line.Overtime_Rate__c}"/>
                        </apex:column>

                        <apex:column rendered="{!afterConfirmed}"
                                     headerValue="{!$ObjectType.TM_Line__c.fields.Premium_Rate__c.Label}">
                            <apex:inputField id="thePremiumRate" onchange="validateFieldInList(this);"
                                             value="{!line.Premium_Rate__c}"/>
                        </apex:column>
                        <apex:column rendered="{!afterConfirmed}" headerValue="{!$ObjectType.TM_Line__c.fields.Pricing_Source_2__c.Label}">
                            <apex:outputField value="{!line.Pricing_Source_2__c}"/>
                        </apex:column>
                        <apex:column rendered="{!afterConfirmed}"
                                     headerValue="{!$ObjectType.TM_Line__c.fields.Tax_Group__c.Label}">
                            <apex:inputField id="theTaxGroup" value="{!line.Tax_Group__c}"
                                             onchange="validateFieldInList(this)" style="width:60px"
                                             styleClass="input-description"/>
                        </apex:column>

                        <apex:column rendered="{!afterConfirmed}" headerValue="{!$ObjectType.TM_Line__c.fields.Unit_Price__c.Label}">
                            <apex:outputField id="theLUnitPrice" value="{!line.Unit_Price__c}"
                                             styleClass="UnitPrice input-numeric"/>
                        </apex:column>

                        <apex:column headerValue="Cost Qty." rendered="{!afterConfirmed}">
                            <apex:outputField value="{!line.Cost_Qty__c}" />
                        </apex:column>
                        <apex:column headerValue="Unit Cost" rendered="{!afterConfirmed}">
                            <apex:outputField value="{!line.Unit_Cost__c}" />
                        </apex:column>
                        <apex:column headerValue="Line Cost" rendered="{!afterConfirmed}">
                            <apex:outputField value="{!line.Line_Cost__c}" />
                        </apex:column>
                        <apex:column rendered="{!afterConfirmed}"
                                     headerValue="{!$ObjectType.TM_Line__c.fields.Line_Amount__c.Label}">
                            <apex:outputField id="theLineAmount" value="{!line.Line_Amount__c}"/>
                        </apex:column>
                        <apex:column rendered="{!afterConfirmed}"
                                     headerValue="{!$ObjectType.TM_Line__c.fields.Line_Amt_Incl_Tax__c.Label}">
                            <apex:outputField id="theLineAmountInclTax" value="{!line.Line_Amt_Incl_Tax__c}"/>
                        </apex:column>

                        <apex:column headerValue="{!$ObjectType.TM_Line__c.fields.Job_Start_Time__c.Label}">
                            <apex:inputField id="theJobStartTime" 
                                             onkeyup="insertColon(this, event);"
                                             onkeypress="return isNumber(event);"
                                             value="{!line.Job_Start_Time__c}" rendered="{!!afterConfirmed || line.Service_Center__r.Temporary__c}"/>
                            <apex:outputField value="{!line.Job_Start_Time__c}" rendered="{!afterConfirmed && NOT(line.Service_Center__r.Temporary__c)}"/>
                        </apex:column>

                        <apex:column headerValue="{!$ObjectType.TM_Line__c.fields.Site_Start_Time__c.Label}">
                            <apex:inputField id="theSiteStartTime"
                                             onkeyup="insertColon(this, event);"
                                             onkeypress="return isNumber(event);"
                                             value="{!line.Site_Start_Time__c}" rendered="{!!afterConfirmed || line.Service_Center__r.Temporary__c}"/>
                            <apex:outputField value="{!line.Site_Start_Time__c}" rendered="{!afterConfirmed && NOT(line.Service_Center__r.Temporary__c)}"/>
                        </apex:column>
                        <apex:column headerValue="{!$ObjectType.TM_Line__c.fields.Site_End_Time__c.Label}">
                            <apex:inputField id="theSiteEndTime" 
                                             onkeyup="insertColon(this, event);"
                                             onkeypress="return isNumber(event);"
                                             value="{!line.Site_End_Time__c}" rendered="{!!afterConfirmed || line.Service_Center__r.Temporary__c}"/>
                            <apex:outputField value="{!line.Site_End_Time__c}" rendered="{!afterConfirmed && NOT(line.Service_Center__r.Temporary__c)}"/>
                        </apex:column>
                        <apex:column headerValue="{!$ObjectType.TM_Line__c.fields.Job_End_Time__c.Label}">
                            <apex:inputField id="theJobEndTime"
                                             onkeyup="insertColon(this, event);"
                                             onkeypress="return isNumber(event);"
                                             value="{!line.Job_End_Time__c}" rendered="{!!afterConfirmed || line.Service_Center__r.Temporary__c}"/>
                            <apex:outputField value="{!line.Job_End_Time__c}" rendered="{!afterConfirmed && NOT(line.Service_Center__r.Temporary__c)}"/>
                        </apex:column>
                        <apex:column headerValue="{!$ObjectType.TM_Line__c.fields.Lunch_Start_Time__c.Label}">
                            <apex:inputField id="theLunchStartTime"
                                             onkeyup="insertColon(this, event);"
                                             onkeypress="return isNumber(event);"
                                             value="{!line.Lunch_Start_Time__c}" rendered="{!!afterConfirmed || line.Service_Center__r.Temporary__c}"/>
                            <apex:outputField value="{!line.Lunch_Start_Time__c}" rendered="{!afterConfirmed && NOT(line.Service_Center__r.Temporary__c)}"/>
                        </apex:column>
                        <apex:column headerValue="{!$ObjectType.TM_Line__c.fields.Lunch_End_Time__c.Label}">
                            <apex:inputField id="theLunchEndTime"
                                             onkeyup="insertColon(this, event);"
                                             onkeypress="return isNumber(event);"
                                             value="{!line.Lunch_End_Time__c}" rendered="{!!afterConfirmed || line.Service_Center__r.Temporary__c}"/>
                            <apex:outputField value="{!line.Lunch_End_Time__c}" rendered="{!afterConfirmed && NOT(line.Service_Center__r.Temporary__c)}"/>
                        </apex:column>
                        <apex:column headerValue="{!$ObjectType.TM_Line__c.fields.Lunch__c.Label}">
                            <apex:inputField id="theLunch" value="{!line.Lunch__c}"
                                             onchange="validateFieldInList(this);" rendered="{!!afterConfirmed}"/>
                            <apex:outputField value="{!line.Lunch__c}" rendered="{!afterConfirmed}"/>
                        </apex:column>

                        <apex:column headerValue="{!$ObjectType.TM_Line__c.fields.Total_Job_Hours__c.Label}">
                            <apex:outputField id="theTotalJobHours" value="{!line.Total_Job_Hours__c}"/>
                        </apex:column>
                        <apex:column headerValue="{!$ObjectType.TM_Line__c.fields.Total_Site_Hours__c.Label}">
                            <apex:outputField id="theTotalSiteHours" value="{!line.Total_Site_Hours__c}"/>
                        </apex:column>
                        <apex:column rendered="{!TM.Contract__c!=null&&afterConfirmed}"  headerValue="{!$ObjectType.TM_Line__c.fields.Contract_Line__c.Label}">

                            <apex:outputpanel >
                                <c:CustomLookup componentId="{!$Component.theTMLLaborTable}:theLContractLine"
                                                styleClass="input-lookup"
                                                style="width: 100px"
                                                secondaryDisplayField="Customer_Description__c"
                                                minSearchLength="1"
                                                stealFocus="true"
                                                sObjectType="TM_Line__c"
                                                sObject="{!line}"
                                                sObjectField="Contract_Line__c"
                                                onchange="validateFieldInList(this);"

                                                allowtoBlank="true"
                                                LookupObject="Contract_Line__c"
                                                LinkFieldName="Name"
                                                FieldSetName="CLFieldSet"
                                                RunValidation="True"
                                                LookupType="ID"
                                                ValidateFunction="validateField"

                                                FilterName1="Resource_Type_Category__c"
                                                FilterNameValue1="Labor"
                                                FilterOperation1="Resource_Type_Category__c"
                                                FilterOperationValue1="="
                                                FilterType1="Resource_Type_Category__c"
                                                FilterTypeValue1="String"

                                                FilterName2="Resource_Type__c"
                                                FilterNameValue2="{!line.Resource_Type__c}"
                                                FilterOperation2="Resource_Type__c"
                                                FilterOperationValue2="="
                                                FilterType2="Resource_Type__c"
                                                FilterTypeValue2="String"

                                                FilterName3="Contract__c"
                                                FilterNameValue3="{!TM.Contract__c}"
                                                FilterOperation3="Contract__c"
                                                FilterOperationValue3="="
                                                FilterType3="Contract__c"
                                                FilterTypeValue3="String"

                                                fltr1="true"
                                                fltr2="true"
                                                fltr3="true"
                                                fltr4="true"
                                                fltr5="true"
                                                fltr6="true"
                                                fltr7="true"
                                />
                            </apex:outputpanel>
                        </apex:column>
                        <apex:column rendered="{!TM.Sales_Order__c!=null&&afterConfirmed}" headerValue="{!$ObjectType.TM_Line__c.fields.Sales_Line__c.Label}">
                            <apex:inputField id="theQuoteLine" value="{!line.Sales_Line__c}" style="width: 100px"/>
                        </apex:column>
                        <apex:column headerValue="{!$ObjectType.TM_Line__c.fields.Contract_Regular_Rate__c.Label}" rendered="{!TM.Contract__c!=null&&afterConfirmed}">
                            <apex:outputField id="theContractRegularRate" value="{!line.Contract_Regular_Rate__c}"/>
                        </apex:column>
                        <apex:column headerValue="{!$ObjectType.TM_Line__c.fields.Contract_Overtime_Rate__c.Label}" rendered="{!TM.Contract__c!=null&&afterConfirmed}">
                            <apex:outputField id="theContractOvertimeRate" value="{!line.Contract_Overtime_Rate__c}"/>
                        </apex:column>
                        <apex:column headerValue="{!$ObjectType.TM_Line__c.fields.Contract_Premium_Rate__c.Label}" rendered="{!TM.Contract__c!=null&&afterConfirmed}">
                            <apex:outputField id="theContractPremiumRate" value="{!line.Contract_Premium_Rate__c}"/>
                        </apex:column>

                        <apex:column headerValue="{!$ObjectType.TM_Line__c.fields.Invoiced__c.Label}">
                            <apex:outputField value="{!line.Invoiced__c}" style="width:50px"/>
                        </apex:column>
                        <apex:column headerValue="{!$ObjectType.TM_Line__c.fields.Line_No__c.Label}">
                            <apex:outputField id="theLineNo" value="{!line.Line_No__c}" style="width:50px"/>
                        </apex:column>
                    </apex:pageBlockTable>
                </apex:outputPanel>
            </apex:pageBlockSection>

            <apex:outputPanel >
                <apex:commandButton value="Add Lines"  action="{!addLine}" oncomplete="setWidth();"
                                    reRender="theTMLLaborTable,theMessage">
                    <apex:param name="ObjectType" value="TMLine"/>
                    <apex:param name="LineCategory" value="{!IF(afterConfirmed, 'TempLabor', 'Labor')}"/>
                </apex:commandButton>

            </apex:outputPanel>
            <div style="float:right;width:600px;font-size:150%;">
                <apex:pageBlockSection rendered="{!afterConfirmed}"
                                       id="TMLLaborTotal" columns="3">
                    <apex:outputText label="SubTotal: " value="{0, number, ###,##0.00}" styleClass="output-numeric">
                        <apex:param value="{!TMLSubtotalLabor}"/>
                    </apex:outputText>
                    <apex:outputText label="Tax: " value="{0, number, ###,##0.00}" styleClass="output-numeric">
                        <apex:param value="{!TMLTaxTotalLabor}"/>
                    </apex:outputText>
                    <apex:outputText label="Total: " value="{0, number, ###,##0.00}" styleClass="output-numeric">
                        <apex:param value="{!TMLtotalLabor}"/>
                    </apex:outputText>
                </apex:pageBlockSection>
            </div>

            <apex:pageBlockSection id="theEquipmentSection" columns="1" title="Equipment Lines" collapsible="true">

                <apex:outputPanel styleClass="tmLineWrap" layout="block">
                    <apex:pageBlockTable id="theTMLEquipmentTable" value="{!TMLListEquipment}" var="line"
                                         rendered="{!NOT(ISNULL(TMLListEquipment))}">
                        <apex:column headerValue="Action" styleClass="actionColumn" style="width:60px">
                            <apex:commandButton value="Delete" disabled="{!afterConfirmed && NOT(line.Service_Center__r.Temporary__c)}" onclick="if(!confirmDelete()){return false};"
                                                action="{!deleteLine}" reRender="theTMLEquipmentTable">
                                <apex:param id="objectType" name="objectType" value="TMLine"/>
                                <apex:param id="displayId" name="displayId" value="{!line.Line_No__c}"/>
                                <apex:param id="lineType" name="lineType" value="Equipment"/>
                            </apex:commandButton>
                            <apex:commandButton value="Copy Time"
                                                disabled="{!afterConfirmed}"
                                                onclick="if(!confirmCopyTime('Equipment')){return false};"
                                                oncomplete="setWidth();"
                                                action="{!copyTime}"
                                                rendered="{!NOT(afterConfirmed)}"
                                                reRender="theTMLEquipmentTable, theMessage, theMessage2">
                                <apex:param id="objectTypeCopy" name="objectType" value="TMLine"/>
                                <apex:param id="displayIdCopy" name="displayId" value="{!line.Line_No__c}"/>
                                <apex:param id="lineTypeCopy" name="lineType" value="Equipment"/>
                            </apex:commandButton>

                            <apex:commandButton value="Copy Billing Time"
                                                disabled="{!NOT(afterConfirmed)}"
                                                onclick="if(!confirmCopyTime('Equipment')){return false};"
                                                oncomplete="setWidth();" action="{!copyTime}"
                                                reRender="theTMLEquipmentTable, theMessage, theMessage2"
                                                rendered="{!afterConfirmed}">
                                <apex:param id="objectTypeCopy_bill" name="objectType" value="TMLine"/>
                                <apex:param id="displayIdCopy_bill" name="displayId" value="{!line.Line_No__c}"/>
                                <apex:param id="lineTypeCopy_bill" name="lineType" value="Equipment"/>
                                <apex:param id="timeTypeCopy_bill" name="timeType" value="BillingTime" />
                            </apex:commandButton>

                        </apex:column>
                        <apex:column headerValue="Equipment Type">

                            <apex:outputpanel >
                                <div class="requiredInput">
                                    <div class="requiredBlock"></div>

                                    <c:CustomLookup componentId="{!$Component.theTMLEquipmentTable}:theEquipment"
                                                    styleClass="input-lookup"
                                                    style="width: 100px"
                                                    filterClause="Blocked__c=false AND Category__c=\'Equipment\'"
                                                    secondaryDisplayField="Description__c"
                                                    minSearchLength="1"
                                                    stealFocus="true"
                                                    sObjectType="TM_Line__c"
                                                    sObject="{!line}"
                                                    sObjectField="Resource_Type__c"
                                                    onchange="validateFieldInList(this);"
                                                    LookupObject="Resource_Type__c"
                                                    LinkFieldName="Name"
                                                    FieldSetName="ResourceTypeFieldSet"
                                                    RunValidation="True"
                                                    LookupType="ID"
                                                    ValidateFunction="validateField"

                                                    allowtoBlank="true"
                                                    FilterName1="Category__c"
                                                    FilterNameValue1="Equipment"
                                                    FilterOperation1="Category__c"
                                                    FilterOperationValue1="="
                                                    FilterType1="Category__c"
                                                    FilterTypeValue1="String"

                                                    FilterName2="Blocked__c"
                                                    FilterNameValue2="false"
                                                    FilterOperation2="Blocked__c"
                                                    FilterOperationValue2="="
                                                    FilterType2="Blocked__c"
                                                    FilterTypeValue2="Boolean"

                                                    fltr1="true"
                                                    fltr2="true"
                                                    fltr3="true"
                                                    fltr4="true"
                                                    fltr5="true"
                                                    fltr6="true"
                                                    fltr7="true"/>
                                </div>
                            </apex:outputpanel>

                        </apex:column>
                        <apex:column headerValue="SC">
                            <apex:outputpanel rendered="{!!afterConfirmed || line.Service_Center__r.Temporary__c}">
                                <div class="requiredInput">
                                    <div class="requiredBlock"></div>
                                    <c:CustomLookup componentId="{!$Component.theTMLEquipmentTable}:theEServiceCenter"
                                                    styleClass="input-lookup"
                                                    style="width: 50px"
                                                    secondaryDisplayField="Description__c"
                                                    minSearchLength="1"
                                                    stealFocus="true"
                                                    sObjectType="TM_Line__c"
                                                    sObject="{!line}"
                                                    sObjectField="Service_Center__c"
                                                    onchange="validateFieldInList(this);"

                                                    allowtoBlank="true"
                                                    LookupObject="Service_Center__c"
                                                    LinkFieldName="Name"
                                                    FieldSetName="ServiceCenterFieldSet"
                                                    RunValidation="True"
                                                    LookupType="ID"
                                                    ValidateFunction="validateField"

                                                    fltr1="true"
                                                    fltr2="true"
                                                    fltr3="true"
                                                    fltr4="true"
                                                    fltr5="true"
                                                    fltr6="true"
                                                    fltr7="true"/>
                                </div>
                            </apex:outputpanel>
                            <apex:outputField value="{!line.Service_Center__c}" rendered="{!afterConfirmed && NOT(line.Service_Center__r.Temporary__c)}"/>
                        </apex:column>
                        <apex:column headerValue="Equipment">
                            <apex:outputpanel rendered="{!!afterConfirmed || line.Service_Center__r.Temporary__c}">
                                <div class="requiredInput">
                                    <div class="requiredBlock"></div>
                                    <c:CustomLookup componentId="{!$Component.theTMLEquipmentTable}:theEResource"
                                                    styleClass="input-lookup"
                                                    style="width: 100px"
                                                    filterClause="Category__c = \'Equipment\' AND (Start_Date__c = null OR
                                                        Start_Date__c <= {!scheduledatefilterFormat}) AND
                                                        (End_Date__c = null OR End_Date__c >= {!scheduledatefilterFormat})
                                                        AND Status__c=\'Available\'"
                                                    secondaryDisplayField="Description__c"
                                                    minSearchLength="1"
                                                    stealFocus="true"
                                                    sObjectType="TM_Line__c"
                                                    sObject="{!line}"
                                                    sObjectField="Resource__c"
                                                    onchange="validateFieldInList(this);"

                                                    allowtoBlank="true"
                                                    LookupObject="Resource__c"
                                                    LinkFieldName="Name"
                                                    FieldSetName="ResourceFieldSet"
                                                    RunValidation="True"
                                                    LookupType="ID"
                                                    ValidateFunction="validateField"

                                                    FilterName1="Category__c"
                                                    FilterNameValue1="Equipment"
                                                    FilterOperation1="Category__c"
                                                    FilterOperationValue1="="
                                                    FilterType1="Category__c"
                                                    FilterTypeValue1="String"

                                                    FilterName2="Status__c"
                                                    FilterNameValue2="Available"
                                                    FilterOperation2="Status__c"
                                                    FilterOperationValue2="="
                                                    FilterType2="Status__c"
                                                    FilterTypeValue2="String"

                                                    FilterName3="Resource_Type__c"
                                                    FilterNameValue3="{!line.Resource_Type__c}"
                                                    FilterOperation3="Resource_Type__c"
                                                    FilterOperationValue3="="
                                                    FilterType3="Resource_Type__c"
                                                    FilterTypeValue3="String"

                                                    FilterName4="Service_Center__c"
                                                    FilterNameValue4="{!line.Service_Center__c}"
                                                    FilterOperation4="Service_Center__c"
                                                    FilterOperationValue4="="
                                                    FilterType4="Service_Center__c"
                                                    FilterTypeValue4="String"

                                                    FilterName1Special="ScheduleDate"
                                                    FilterNameValue1Special="{!scheduledDateValue}"
                                                    FilterOperation1Special="ScheduleDate"
                                                    FilterOperationValue1Special="<="
                                                    FilterType1Special="ScheduleDate"
                                                    FilterTypeValue1Special="Date"

                                                    calledFrom="TM"
                                                    calledFor="EquipmentResourceLookup"
                                                    isSpecialScenario="true"

                                                    fltr1="true"
                                                    fltr2="true"
                                                    fltr3="true"
                                                    fltr4="true"
                                                    fltr5="true"
                                                    fltr6="true"
                                                    fltr7="true"/>
                                </div>
                            </apex:outputpanel>
                            <apex:outputField value="{!line.Resource__c}" rendered="{!afterConfirmed && NOT(line.Service_Center__r.Temporary__c)}"/>
                        </apex:column>
                        <apex:column headerValue="Equipment Name">
                            <apex:inputField id="theResourceName" value="{!line.Resource_Name__c}"/>
                        </apex:column>
                        <apex:column headerValue="{!$ObjectType.TM_Line__c.fields.Description__c.Label}">
                            <apex:inputField id="theDescription" value="{!line.Description__c}"/>
                        </apex:column>

                        <apex:column headerValue="Equipment Operator">

                            <apex:outputField value="{!line.Linked_Line__r.Resource_Name__c}"/>
                        </apex:column>

                        
                        <apex:column rendered="{!afterConfirmed}"
                                     headerValue="{!$ObjectType.TM_Line__c.fields.Fleet_No_Required__c.Label}">
                            <apex:outputField value="{!line.Fleet_No_Required__c}"/>
                        </apex:column>
                        <apex:column rendered="{!afterConfirmed}"
                                     headerValue="{!$ObjectType.TM_Line__c.fields.Fleet_No__c.Label}">
                            <apex:inputField id="theEFleetNumber" value="{!line.Fleet_No__c}"/>
                        </apex:column>

                        <apex:column rendered="{!!afterConfirmed}" headerValue="{!$ObjectType.TM_Line__c.fields.Job_Start_Time__c.Label}">
                            <apex:inputField id="theESiteStartTime"
                                             onkeyup="insertColon(this, event);"
                                             onkeypress="return isNumber(event);"
                                             value="{!line.Job_Start_Time__c}"/>
                        </apex:column>
                        <apex:column rendered="{!!afterConfirmed}" headerValue="{!$ObjectType.TM_Line__c.fields.Job_End_Time__c.Label}">
                            <apex:inputField id="theESiteEndTime"
                                             onkeyup="insertColon(this, event);"
                                             onkeypress="return isNumber(event);"
                                             value="{!line.Job_End_Time__c}"/>
                        </apex:column>
                        <apex:column rendered="{!afterConfirmed}"
                                     headerValue="{!$ObjectType.TM_Line__c.fields.Billing_Start_Time__c.Label}">
                            <apex:inputField id="theEBillingStartTime"
                                             onkeyup="insertColon(this, event);"
                                             onkeypress="return isNumber(event);"
                                             value="{!line.Billing_Start_Time__c}" onchange="validateFieldInList(this);"/>
                        </apex:column>
                        <apex:column rendered="{!afterConfirmed}"
                                     headerValue="{!$ObjectType.TM_Line__c.fields.Billing_End_Time__c.Label}">
                            <apex:inputField id="theEBillingEndTime"
                                             onkeyup="insertColon(this, event);"
                                             onkeypress="return isNumber(event);"
                                             value="{!line.Billing_End_Time__c}" onchange="validateFieldInList(this);"/>
                        </apex:column>
                        <apex:column rendered="{!TM.Contract__r.Allow_Lunch_Time_on_Equipment__c == true}"
                                headerValue="{!$ObjectType.TM_Line__c.fields.Lunch__c.Label}">
                            <apex:inputField id="theELunch" value="{!line.Lunch__c}" onChange="validateFieldInList(this);" />
                        </apex:column>
                        <apex:column rendered="{!NOT(afterConfirmed)}"
                                    headerValue="{!$ObjectType.TM_Line__c.fields.Total_Job_Hours__c.Label}">
                            <apex:outputField id="theETotalJobHours" value="{!line.Total_Job_Hours__c}"/>
                        </apex:column>
                        <apex:column rendered="{!afterConfirmed}"
                                     headerValue="{!$ObjectType.TM_Line__c.fields.Hour__c.Label}">
                            <apex:outputField id="theHour" value="{!line.Hour__c}" style="width:60px"/>
                        </apex:column>

                        <apex:column headerValue="{!$ObjectType.TM_Line__c.fields.Quantity__c.Label}">
                            <apex:inputField id="theEQuantity" value="{!line.Quantity__c}"
                                             onchange="validateFieldInList(this);"/>
                        </apex:column>
                        <apex:column headerValue="{!$ObjectType.TM_Line__c.fields.Unit_of_Measure__c.Label}">
                            <apex:outputpanel >
                                <div class="requiredInput">
                                    <div class="requiredBlock"></div>
                                    <c:CustomLookup componentId="{!$Component.theTMLEquipmentTable}:theEUOM"
                                                    styleClass="input-lookup"
                                                    style="width: 100px"
                                                    secondaryDisplayField="Description__c"
                                                    minSearchLength="1"
                                                    stealFocus="true"
                                                    sObjectType="TM_Line__c"
                                                    sObject="{!line}"
                                                    sObjectField="Unit_of_Measure__c"
                                                    onchange="validateFieldInList(this);"

                                                    allowtoBlank="true"
                                                    LookupObject="Unit_of_Measure__c"
                                                    LinkFieldName="Name"
                                                    FieldSetName="UOMFieldSet"
                                                    RunValidation="True"
                                                    LookupType="ID"
                                                    ValidateFunction="validateField"

                                                    FilterName1Special="ResourceType"
                                                    FilterNameValue1Special="{!line.Resource_Type__c}"
                                                    FilterOperation1Special="ResourceType"
                                                    FilterOperationValue1Special="="
                                                    FilterType1Special="ResourceType"
                                                    FilterTypeValue1Special="string"

                                                    calledFrom="TM"
                                                    calledFor="ResourceTypeUOMLookup"
                                                    isSpecialScenario="true"

                                                    fltr1="true"
                                                    fltr2="true"
                                                    fltr3="true"
                                                    fltr4="true"
                                                    fltr5="true"
                                                    fltr6="true"
                                                    fltr7="true"
                                    />
                                </div>


                            </apex:outputpanel>
                        </apex:column>

                        <apex:column rendered="{!afterConfirmed}" headerValue="{!$ObjectType.TM_Line__c.fields.Bill_as_Lump_Sum__c.Label}">
                            <apex:inputField id="theEBillasLumpSum" value="{!line.Bill_as_Lump_Sum__c}" onchange="validateFieldInList(this);"/>
                        </apex:column>
                        <apex:column rendered="{!afterConfirmed}" headerValue="{!$ObjectType.TM_Line__c.fields.Non_Billable__c.Label}">
                            <apex:inputField id="theENonBillable" value="{!line.Non_Billable__c}" onchange="validateFieldInList(this);"/>
                        </apex:column>

                        <apex:column rendered="{!afterConfirmed}"
                                     headerValue="{!$ObjectType.TM_Line__c.fields.Unit_Price__c.Label}">
                            <apex:inputField id="theEUnitPrice" value="{!line.Unit_Price__c}"
                                             onchange="validateFieldInList(this)" style="width:60px"
                                             styleClass="UnitPrice input-numeric"/>
                        </apex:column>
                        <apex:column rendered="{!afterConfirmed}"
                                     headerValue="{!$ObjectType.TM_Line__c.fields.Unit_Cost__c.Label}">
                            <apex:outputField value="{!line.Unit_Cost__c}"
                                             style="width:60px"
                                             styleClass="UnitPrice input-numeric"/>
                        </apex:column>
                        <apex:column rendered="{!afterConfirmed}" headerValue="{!$ObjectType.TM_Line__c.fields.Pricing_Source_2__c.Label}">
                            <apex:outputField value="{!line.Pricing_Source_2__c}"/>
                        </apex:column>
                        <apex:column rendered="{!afterConfirmed}"
                                     headerValue="{!$ObjectType.TM_Line__c.fields.Tax_Group__c.Label}">
                            <apex:inputField id="theETaxGroup" value="{!line.Tax_Group__c}"
                                             onchange="validateFieldInList(this)" style="width:60px"
                                             styleClass="input-description"/>
                        </apex:column>
                        <apex:column rendered="{!afterConfirmed}"
                                     headerValue="{!$ObjectType.TM_Line__c.fields.Line_Amount__c.Label}">
                            <apex:outputText id="theLineAmount" value="{0, number, ###,##0.00}"
                                             styleClass="LineCost output-numeric" style="width:60px">
                                <apex:param value="{!line.Line_Amount__c}"/>
                            </apex:outputText>
                        </apex:column>
                        <apex:column rendered="{!afterConfirmed}"
                                     headerValue="{!$ObjectType.TM_Line__c.fields.Line_Amt_Incl_Tax__c.Label}">
                            <apex:outputText id="theAmtInclTax" value="{0, number, ###,##0.00}"
                                             styleClass="LineCost output-numeric" style="width:60px">
                                <apex:param value="{!line.Line_Amt_Incl_Tax__c}"/>
                            </apex:outputText>
                        </apex:column>
                        <apex:column headerValue="{!$ObjectType.TM_Line__c.fields.Contract_Line__c.Label}" rendered="{!TM.Contract__c!=null&&afterConfirmed}">

                            <apex:outputpanel >
                                <c:CustomLookup componentId="{!$Component.theTMLEquipmentTable}:theEContractLine"
                                                styleClass="input-lookup"
                                                style="width: 100px"
                                                secondaryDisplayField="Name"
                                                minSearchLength="1"
                                                stealFocus="true"
                                                sObjectType="TM_Line__c"
                                                sObject="{!line}"
                                                sObjectField="Contract_Line__c"
                                                onchange="validateFieldInList(this);"

                                                allowtoBlank="true"
                                                LookupObject="Contract_Line__c"
                                                LinkFieldName="Name"
                                                FieldSetName="CLFieldSet"
                                                RunValidation="True"
                                                LookupType="ID"
                                                ValidateFunction="validateField"

                                                FilterName1="Resource_Type_Category__c"
                                                FilterNameValue1="Equipment"
                                                FilterOperation1="Resource_Type_Category__c"
                                                FilterOperationValue1="="
                                                FilterType1="Resource_Type_Category__c"
                                                FilterTypeValue1="String"

                                                FilterName2="Resource_Type__c"
                                                FilterNameValue2="{!line.Resource_Type__c}"
                                                FilterOperation2="Resource_Type__c"
                                                FilterOperationValue2="="
                                                FilterType2="Resource_Type__c"
                                                FilterTypeValue2="String"

                                                FilterName3="Contract__c"
                                                FilterNameValue3="{!TM.Contract__c}"
                                                FilterOperation3="Contract__c"
                                                FilterOperationValue3="="
                                                FilterType3="Contract__c"
                                                FilterTypeValue3="String"

                                                fltr1="true"
                                                fltr2="true"
                                                fltr3="true"
                                                fltr4="true"
                                                fltr5="true"
                                                fltr6="true"
                                                fltr7="true"
                                />
                            </apex:outputpanel>
                        </apex:column>
                        <apex:column rendered="{!TM.Sales_Order__c!=null&&afterConfirmed}" headerValue="{!$ObjectType.TM_Line__c.fields.Sales_Line__c.Label}">
                            <apex:inputField id="theQuoteLine" value="{!line.Sales_Line__c}" style="width: 100px"/>
                        </apex:column>
                        <apex:column rendered="{!TM.Contract__c!=null&&afterConfirmed}" headerValue="{!$ObjectType.TM_Line__c.fields.Contract_Regular_Rate__c.Label}">
                            <apex:outputField id="theEContractRegularRate" value="{!line.Contract_Regular_Rate__c}"/>
                        </apex:column>

                        <apex:column headerValue="{!$ObjectType.TM_Line__c.fields.Rental_Allowed__c.Label}">
                            <apex:outputField value="{!line.Rental_Allowed__c}"/>
                        </apex:column>
                        <apex:column headerValue="{!$ObjectType.TM_Line__c.fields.Pick_Up_Rental__c.Label}">
                            <apex:inputField id="thePickUpRental" value="{!line.Pick_Up_Rental__c}"/>
                        </apex:column>
                        <apex:column headerValue="{!$ObjectType.TM_Line__c.fields.Pick_Up_R_O__c.Label}">
                            <apex:inputField id="thePickUpRO" value="{!line.Pick_Up_R_O__c}"/>
                        </apex:column>
                        <apex:column headerValue="{!$ObjectType.TM_Line__c.fields.Drop_Off_Rental__c.Label}">
                            <apex:inputField id="theDropOffRental" value="{!line.Drop_Off_Rental__c}"/>
                        </apex:column>
                        <apex:column headerValue="{!$ObjectType.TM_Line__c.fields.Drop_Off_R_O__c.Label}">
                            <apex:inputField id="theDropOffRO" value="{!line.Drop_Off_R_O__c}"/>
                        </apex:column>
                        <apex:column rendered="{!afterConfirmed}"
                                     headerValue="{!$ObjectType.TM_Line__c.fields.Rent_Billing_Type__c.Label}">
                            <apex:inputField id="theRentBillingType" value="{!line.Rent_Billing_Type__c}"/>
                        </apex:column>
                        <apex:column rendered="{!afterConfirmed}"
                                     headerValue="{!$ObjectType.TM_Line__c.fields.Rent_Billing_Amount__c.Label}">
                            <apex:inputField id="theRentBillingAmount" value="{!line.Rent_Billing_Amount__c}"/>
                        </apex:column>

                        <apex:column rendered="{!afterConfirmed}" headerValue="{!$ObjectType.TM_Line__c.fields.Job_Start_Time__c.Label}">
                            <apex:inputField id="theESiteStartTime2"
                                             onkeyup="insertColon(this, event);"
                                             onkeypress="return isNumber(event);"
                                             value="{!line.Job_Start_Time__c}"  rendered="{!line.Service_Center__r.Temporary__c}"/>
                            <apex:outputField value="{!line.Job_Start_Time__c}"  rendered="{!NOT(line.Service_Center__r.Temporary__c)}"/>
                        </apex:column>
                        <apex:column rendered="{!afterConfirmed}" headerValue="{!$ObjectType.TM_Line__c.fields.Job_End_Time__c.Label}">
                            <apex:inputField id="theESiteEndTime2"
                                             onkeyup="insertColon(this, event);"
                                             onkeypress="return isNumber(event);"
                                             value="{!line.Job_End_Time__c}" rendered="{!line.Service_Center__r.Temporary__c}"/>
                            <apex:outputField value="{!line.Job_End_Time__c}" rendered="{!NOT(line.Service_Center__r.Temporary__c)}"/>
                        </apex:column>
                        <apex:column rendered="{!afterConfirmed}" headerValue="{!$ObjectType.TM_Line__c.fields.Total_Job_Hours__c.Label}">
                            <apex:outputField value="{!line.Total_Job_Hours__c}"/>
                        </apex:column>

                        <apex:column headerValue="{!$ObjectType.TM_Line__c.fields.Invoiced__c.Label}">
                            <apex:outputField value="{!line.Invoiced__c}" style="width:50px"/>
                        </apex:column>
                        <apex:column headerValue="{!$ObjectType.TM_Line__c.fields.Line_No__c.Label}">
                            <apex:outputField id="theLineNo" value="{!line.Line_No__c}" style="width:50px"/>
                        </apex:column>
                    </apex:pageBlockTable>
                </apex:outputPanel>
            </apex:pageBlockSection>

            <apex:outputPanel >
                <apex:commandButton value="Add Lines" action="{!addLine}" oncomplete="setWidth();"
                                    reRender="theTMLEquipmentTable,theMessage">
                    <apex:param name="ObjectType" value="TMLine"/>
                    <apex:param name="LineCategory" value="{!IF(afterConfirmed, 'TempEquipment', 'Equipment')}"/>
                </apex:commandButton>
            </apex:outputPanel>
            <div style="float:right;width:600px;font-size:150%;">
                <apex:pageBlockSection rendered="{!afterConfirmed}"
                                       id="TMLEquipmentTotal" columns="3">
                    <apex:outputText label="SubTotal: " value="{0, number, ###,##0.00}" styleClass="output-numeric">
                        <apex:param value="{!TMLSubtotalEquipment}"/>
                    </apex:outputText>
                    <apex:outputText label="Tax: " value="{0, number, ###,##0.00}" styleClass="output-numeric">
                        <apex:param value="{!TMLTaxTotalEquipment}"/>
                    </apex:outputText>
                    <apex:outputText label="Total: " value="{0, number, ###,##0.00}" styleClass="output-numeric">
                        <apex:param value="{!TMLtotalEquipment}"/>
                    </apex:outputText>
                </apex:pageBlockSection>
            </div>

            <apex:pageBlockSection id="theMaterialsSection" columns="1" title="Material Lines" collapsible="true">

                <apex:outputPanel styleClass="tmLineWrap" layout="block">
                    <apex:pageBlockTable id="theTMLMaterialsTable" value="{!TMLListMaterials}" var="line"
                                         rendered="{!NOT(ISNULL(TMLListMaterials))}">
                        <apex:column headerValue="Action" styleClass="actionColumn" style="width:60px">
                            <apex:commandButton value="Delete" disabled="{!afterInvoiced}" onclick="if(!confirmDelete()){return false};"
                                                action="{!deleteLine}" reRender="theTMLMaterialsTable">
                                <apex:param id="objectType" name="objectType" value="TMLine"/>
                                <apex:param id="displayId" name="displayId" value="{!line.Line_No__c}"/>
                                <apex:param id="lineType" name="lineType" value="Materials"/>
                            </apex:commandButton>
                        </apex:column>
                        <apex:column headerValue="Material">
                            <apex:outputpanel >
                                <div class="requiredInput">
                                    <div class="requiredBlock"></div>
                                    <c:CustomLookup componentId="{!$Component.theTMLMaterialsTable}:theMResource"
                                                    styleClass="input-lookup"
                                                    style="width: 100px"
                                                    filterClause="Blocked__c=false AND Category__c = \'Materials\'"
                                                    secondaryDisplayField="Description__c"
                                                    minSearchLength="1"
                                                    stealFocus="true"
                                                    sObjectType="TM_Line__c"
                                                    sObject="{!line}"
                                                    sObjectField="Resource__c"
                                                    onchange="validateFieldInList(this);"

                                                    allowtoBlank="true"
                                                    LookupObject="Resource__c"
                                                    LinkFieldName="Name"
                                                    FieldSetName="ResourceFieldSet"
                                                    RunValidation="True"
                                                    LookupType="ID"
                                                    ValidateFunction="validateField"

                                                    FilterName1="Category__c"
                                                    FilterNameValue1="Materials"
                                                    FilterOperation1="Category__c"
                                                    FilterOperationValue1="="
                                                    FilterType1="Category__c"
                                                    FilterTypeValue1="String"

                                                    FilterName2="Blocked__c"
                                                    FilterNameValue2="false"
                                                    FilterOperation2="Blocked__c"
                                                    FilterOperationValue2="="
                                                    FilterType2="Blocked__c"
                                                    FilterTypeValue2="Boolean"

                                                    fltr1="true"
                                                    fltr2="true"
                                                    fltr3="true"
                                                    fltr4="true"
                                                    fltr5="true"
                                                    fltr6="true"
                                                    fltr7="true"/>
                                </div>
                            </apex:outputpanel>

                        </apex:column>

                        <apex:column headerValue="Billing Description">
                            <apex:inputField id="theDescription" value="{!line.Description__c}"/>
                        </apex:column>
                        <apex:column headerValue="{!$ObjectType.TM_Line__c.fields.Quantity__c.Label}">
                            <apex:inputField id="theMQuantity" onchange="validateFieldInList(this);"
                                             value="{!line.Quantity__c}"/>
                        </apex:column>
                        <apex:column headerValue="{!$ObjectType.TM_Line__c.fields.Unit_of_Measure__c.Label}">
                            <apex:outputpanel >
                                <div class="requiredInput">
                                    <div class="requiredBlock"></div>
                                    <c:CustomLookup componentId="{!$Component.theTMLMaterialsTable}:theMUOM"
                                                    styleClass="input-lookup"
                                                    style="width: 100px"
                                                    secondaryDisplayField="Description__c"
                                                    minSearchLength="1"
                                                    stealFocus="true"
                                                    sObjectType="TM_Line__c"
                                                    sObject="{!line}"
                                                    sObjectField="Unit_of_Measure__c"
                                                    onchange="validateFieldInList(this);"

                                                    allowtoBlank="true"
                                                    LookupObject="Unit_of_Measure__c"
                                                    LinkFieldName="Name"
                                                    FieldSetName="UOMFieldSet"
                                                    RunValidation="True"
                                                    LookupType="ID"
                                                    ValidateFunction="validateField"

                                                    FilterName1Special="Resource"
                                                    FilterNameValue1Special="{!line.Resource__c}"
                                                    FilterOperation1Special="Resource"
                                                    FilterOperationValue1Special="="
                                                    FilterType1Special="Resource"
                                                    FilterTypeValue1Special="string"

                                                    calledFrom="TM"
                                                    calledFor="MUOMLookUp"
                                                    isSpecialScenario="true"

                                                    fltr1="true"
                                                    fltr2="true"
                                                    fltr3="true"
                                                    fltr4="true"
                                                    fltr5="true"
                                                    fltr6="true"
                                                    fltr7="true"
                                    />
                                </div>

                            </apex:outputpanel>
                        </apex:column>
                        <apex:column rendered="{!afterConfirmed}"
                                     headerValue="{!$ObjectType.TM_Line__c.fields.Unit_Price__c.Label}">
                            <apex:inputField id="theMUnitPrice" value="{!line.Unit_Price__c}"
                                             onchange="validateFieldInList(this);" style="width:60px"
                                             styleClass="UnitPrice input-numeric"/>
                        </apex:column>
                        <apex:column rendered="{!afterConfirmed}" headerValue="{!$ObjectType.TM_Line__c.fields.Pricing_Source_2__c.Label}">
                            <apex:outputField value="{!line.Pricing_Source_2__c}"/>
                        </apex:column>
                        <apex:column rendered="{!afterConfirmed}"
                                     headerValue="{!$ObjectType.TM_Line__c.fields.Tax_Group__c.Label}">
                            <apex:inputField id="theMTaxGroup" value="{!line.Tax_Group__c}"
                                             onchange="validateFieldInList(this);" style="width:60px"
                                             styleClass="input-description"/>
                        </apex:column>


                        <apex:column rendered="{!afterConfirmed}" headerValue="{!$ObjectType.TM_Line__c.fields.Bill_as_Lump_Sum__c.Label}">
                            <apex:inputField id="theMBillasLumpSum" value="{!line.Bill_as_Lump_Sum__c}" onchange="validateFieldInList(this);"/>
                        </apex:column>
                        <apex:column rendered="{!afterConfirmed}" headerValue="{!$ObjectType.TM_Line__c.fields.Non_Billable__c.Label}">
                            <apex:inputField id="theMNonBillable" value="{!line.Non_Billable__c}" onchange="validateFieldInList(this);"/>
                        </apex:column>


                        <apex:column rendered="{!afterConfirmed}"
                                     headerValue="{!$ObjectType.TM_Line__c.fields.Line_Amount__c.Label}">
                            <apex:outputText id="theLineAmount" value="{0, number, ###,##0.00}"
                                             styleClass="LineCost output-numeric" style="width:60px">
                                <apex:param value="{!line.Line_Amount__c}"/>
                            </apex:outputText>
                        </apex:column>
                        <apex:column rendered="{!afterConfirmed}"
                                     headerValue="{!$ObjectType.TM_Line__c.fields.Line_Amt_Incl_Tax__c.Label}">
                            <apex:outputText id="theAmtInclTax" value="{0, number, ###,##0.00}"
                                             styleClass="LineCost output-numeric" style="width:60px">
                                <apex:param value="{!line.Line_Amt_Incl_Tax__c}"/>
                            </apex:outputText>
                        </apex:column>

                        <apex:column rendered="{!TM.Contract__c!=null&&afterConfirmed}" headerValue="{!$ObjectType.TM_Line__c.fields.Contract_Line__c.Label}">

                            <apex:outputpanel >
                                <c:CustomLookup componentId="{!$Component.theTMLMaterialsTable}:theMContractLine"
                                                styleClass="input-lookup"
                                                style="width: 100px"
                                                secondaryDisplayField="Name"
                                                minSearchLength="1"
                                                stealFocus="true"
                                                sObjectType="TM_Line__c"
                                                sObject="{!line}"
                                                sObjectField="Contract_Line__c"
                                                onchange="validateFieldInList(this);"

                                                allowtoBlank="true"
                                                LookupObject="Contract_Line__c"
                                                LinkFieldName="Name"
                                                FieldSetName="CLFieldSet"
                                                RunValidation="True"
                                                LookupType="ID"
                                                ValidateFunction="validateField"

                                                FilterName1="Resource_Category__c"
                                                FilterNameValue1="Materials"
                                                FilterOperation1="Resource_Category__c"
                                                FilterOperationValue1="="
                                                FilterType1="Resource_Category__c"
                                                FilterTypeValue1="String"

                                                FilterName2="Resource__c"
                                                FilterNameValue2="{!line.Resource__c}"
                                                FilterOperation2="Resource__c"
                                                FilterOperationValue2="="
                                                FilterType2="Resource__c"
                                                FilterTypeValue2="String"

                                                FilterName3="Contract__c"
                                                FilterNameValue3="{!TM.Contract__c}"
                                                FilterOperation3="Contract__c"
                                                FilterOperationValue3="="
                                                FilterType3="Contract__c"
                                                FilterTypeValue3="String"

                                                fltr1="true"
                                                fltr2="true"
                                                fltr3="true"
                                                fltr4="true"
                                                fltr5="true"
                                                fltr6="true"
                                                fltr7="true"
                                />
                            </apex:outputpanel>
                        </apex:column>
                        <apex:column rendered="{!TM.Sales_Order__c!=null&&afterConfirmed}" headerValue="{!$ObjectType.TM_Line__c.fields.Sales_Line__c.Label}">
                            <apex:inputField id="theQuoteLine" value="{!line.Sales_Line__c}" style="width: 100px"/>
                        </apex:column>
                        <apex:column rendered="{!TM.Contract__c!=null&&afterConfirmed}" headerValue="{!$ObjectType.TM_Line__c.fields.Contract_Regular_Rate__c.Label}">
                            <apex:outputField id="theMContractRegularRate" value="{!line.Contract_Regular_Rate__c}"/>
                        </apex:column>

                        <apex:column headerValue="{!$ObjectType.TM_Line__c.fields.Invoiced__c.Label}">
                            <apex:outputField value="{!line.Invoiced__c}" style="width:50px"/>
                        </apex:column>
                        <apex:column headerValue="{!$ObjectType.TM_Line__c.fields.Line_No__c.Label}">
                            <apex:outputField id="theLineNo" value="{!line.Line_No__c}" style="width:50px"/>
                        </apex:column>
                    </apex:pageBlockTable>
                </apex:outputPanel>
            </apex:pageBlockSection>

            <apex:outputPanel >
                <apex:commandButton value="Add Lines" disabled="{!afterInvoiced}" action="{!addLine}" reRender="theTMLMaterialsTable,theMessage">
                    <apex:param name="ObjectType" value="TMLine"/>
                    <apex:param name="LineCategory" value="Materials"/>
                </apex:commandButton>
            </apex:outputPanel>
            <div style="float:right;width:600px;font-size:150%;">
                <apex:pageBlockSection rendered="{!afterConfirmed}"
                                       id="TMLMaterialsTotal" columns="3">
                    <apex:outputText label="SubTotal: " value="{0, number, ###,##0.00}" styleClass="output-numeric">
                        <apex:param value="{!TMLSubtotalMaterials}"/>
                    </apex:outputText>
                    <apex:outputText label="Tax: " value="{0, number, ###,##0.00}" styleClass="output-numeric">
                        <apex:param value="{!TMLTaxTotalMaterials}"/>
                    </apex:outputText>
                    <apex:outputText label="Total: " value="{0, number, ###,##0.00}" styleClass="output-numeric">
                        <apex:param value="{!TMLtotalMaterials}"/>
                    </apex:outputText>
                </apex:pageBlockSection>
            </div>

            <apex:pageBlockSection id="theSubcontractorsSection" columns="1" title="Cost Plus Materials, Equipment, and Services"
                                   collapsible="true">

                <apex:outputPanel styleClass="tmLineWrap" layout="block">
                    <apex:pageBlockTable id="theTMLSubcontractorsTable" value="{!TMLListSubcontractors}" var="line"
                                         rendered="{!NOT(ISNULL(TMLListSubcontractors))}">
                        <apex:column headerValue="Action" styleClass="actionColumn" style="width:60px">
                            <apex:commandButton value="Delete" disabled="{!afterInvoiced}" onclick="if(!confirmDelete()){return false};"
                                                action="{!deleteLine}" reRender="theTMLSubcontractorsTable">
                                <apex:param id="objectType" name="objectType" value="TMLine"/>
                                <apex:param id="displayId" name="displayId" value="{!line.Line_No__c}"/>
                                <apex:param id="lineType" name="lineType" value="Subcontractors"/>
                            </apex:commandButton>
                        </apex:column>

                        <apex:column headerValue="{!$ObjectType.TM_Line__c.fields.Description__c.Label}">
                            <apex:inputField id="theDescription" value="{!line.Description__c}"/>
                        </apex:column>
                        <apex:column rendered="{!afterConfirmed}"
                                     headerValue="{!$ObjectType.TM_Line__c.fields.Quantity__c.Label}">
                            <apex:inputField id="theSQuantity" value="{!line.Quantity__c}"
                                             onchange="validateFieldInList(this);"/>
                        </apex:column>
                        <apex:column headerValue="{!$ObjectType.TM_Line__c.fields.Unit_of_Measure__c.Label}">
                            <apex:outputpanel >
                                <div class="requiredInput">
                                    <div class="requiredBlock"></div>
                                    <c:CustomLookup componentId="{!$Component.theTMLSubcontractorsTable}:theSUOM"
                                                    styleClass="input-lookup"
                                                    style="width: 100px"
                                                    secondaryDisplayField="Description__c"
                                                    minSearchLength="1"
                                                    stealFocus="true"
                                                    sObjectType="TM_Line__c"
                                                    sObject="{!line}"
                                                    sObjectField="Unit_of_Measure__c"
                                                    onchange="validateFieldInList(this);"

                                                    allowtoBlank="true"
                                                    LookupObject="Unit_of_Measure__c"
                                                    LinkFieldName="Name"
                                                    FieldSetName="UOMFieldSet"
                                                    RunValidation="True"
                                                    LookupType="ID"
                                                    ValidateFunction="validateField"

                                                    fltr1="true"
                                                    fltr2="true"
                                                    fltr3="true"
                                                    fltr4="true"
                                                    fltr5="true"
                                                    fltr6="true"
                                                    fltr7="true"
                                    />
                                </div>

                            </apex:outputpanel>
                        </apex:column>
                        <apex:column rendered="{!afterConfirmed}"
                                     headerValue="{!$ObjectType.TM_Line__c.fields.Unit_Price__c.Label}">
                            <apex:inputField id="theSUnitPrice" value="{!line.Unit_Price__c}"
                                             onchange="validateFieldInList(this)" style="width:60px"
                                             styleClass="UnitPrice input-numeric"/>
                        </apex:column>
                        <apex:column rendered="{!afterConfirmed}" headerValue="{!$ObjectType.TM_Line__c.fields.Pricing_Source_2__c.Label}">
                            <apex:outputField value="{!line.Pricing_Source_2__c}"/>
                        </apex:column>
                        <apex:column rendered="{!afterConfirmed}"
                                     headerValue="{!$ObjectType.TM_Line__c.fields.Markup_Option__c.Label}">
                            <apex:inputField id="theSMarkupOption" value="{!line.Markup_Option__c}"
                                             onchange="validateFieldInList(this);"/>
                        </apex:column>
                        <apex:column rendered="{!afterConfirmed}"
                                     headerValue="{!$ObjectType.TM_Line__c.fields.Markup__c.Label}">
                            <apex:inputField id="theSMarkup" value="{!line.Markup__c}"
                                             onchange="validateFieldInList(this);"/>
                        </apex:column>
                        <apex:column rendered="{!afterConfirmed}"
                                     headerValue="{!$ObjectType.TM_Line__c.fields.Tax_Group__c.Label}">
                            <apex:inputField id="theSTaxGroup" value="{!line.Tax_Group__c}"
                                             onchange="validateFieldInList(this);" style="width:60px"
                                             styleClass="input-description"/>
                        </apex:column>


                        <apex:column rendered="{!afterConfirmed}" headerValue="{!$ObjectType.TM_Line__c.fields.Bill_as_Lump_Sum__c.Label}">
                            <apex:inputField id="theSBillasLumpSum" value="{!line.Bill_as_Lump_Sum__c}" onchange="validateFieldInList(this);"/>
                        </apex:column>
                        <apex:column rendered="{!afterConfirmed}" headerValue="{!$ObjectType.TM_Line__c.fields.Non_Billable__c.Label}">
                            <apex:inputField id="theSNonBillable" value="{!line.Non_Billable__c}" onchange="validateFieldInList(this);"/>
                        </apex:column>

                        <apex:column rendered="{!afterConfirmed}"
                                     headerValue="{!$ObjectType.TM_Line__c.fields.Line_Cost__c.Label}">
                            <apex:outputText id="theSLineCost" value="{0, number, ###,##0.00}"
                                             styleClass="LineCost output-numeric" style="width:60px">
                                <apex:param value="{!line.Line_Cost__c}"/>
                            </apex:outputText>
                        </apex:column>

                        <apex:column rendered="{!afterConfirmed}"
                                     headerValue="{!$ObjectType.TM_Line__c.fields.Line_Amount__c.Label}">
                            <apex:outputText id="theLineAmount" value="{0, number, ###,##0.00}"
                                             styleClass="LineCost output-numeric" style="width:60px">
                                <apex:param value="{!line.Line_Amount__c}"/>
                            </apex:outputText>
                        </apex:column>
                        <apex:column rendered="{!afterConfirmed}"
                                     headerValue="{!$ObjectType.TM_Line__c.fields.Line_Amt_Incl_Tax__c.Label}">
                            <apex:outputText id="theAmtInclTax" value="{0, number, ###,##0.00}"
                                             styleClass="LineCost output-numeric" style="width:60px">
                                <apex:param value="{!line.Line_Amt_Incl_Tax__c}"/>
                            </apex:outputText>
                        </apex:column>
                        <apex:column rendered="{!TM.Sales_Order__c!=null&&afterConfirmed}" headerValue="{!$ObjectType.TM_Line__c.fields.Sales_Line__c.Label}">
                            <apex:inputField id="theQuoteLine" value="{!line.Sales_Line__c}" style="width: 100px"/>
                        </apex:column>

                        <apex:column headerValue="{!$ObjectType.TM_Line__c.fields.Invoiced__c.Label}">
                            <apex:outputField value="{!line.Invoiced__c}" style="width:50px"/>
                        </apex:column>
                        <apex:column headerValue="{!$ObjectType.TM_Line__c.fields.Line_No__c.Label}">
                            <apex:outputField id="theLineNo" value="{!line.Line_No__c}" style="width:50px"/>
                        </apex:column>
                    </apex:pageBlockTable>
                </apex:outputPanel>
            </apex:pageBlockSection>

            <apex:outputPanel >
                <apex:commandButton value="Add Lines" disabled="{!afterInvoiced}" action="{!addLine}"
                                    reRender="theTMLSubcontractorsTable,theMessage">
                    <apex:param name="ObjectType" value="TMLine"/>
                    <apex:param name="LineCategory" value="Subcontractors"/>
                </apex:commandButton>
            </apex:outputPanel>
            <div style="float:right;width:600px;font-size:150%;">
                <apex:pageBlockSection rendered="{!afterConfirmed}"
                                       id="TMLSubcontractorsTotal" columns="3">
                    <apex:outputText label="SubTotal: " value="{0, number, ###,##0.00}" styleClass="output-numeric">
                        <apex:param value="{!TMLSubtotalSubcontractors}"/>
                    </apex:outputText>
                    <apex:outputText label="Tax: " value="{0, number, ###,##0.00}" styleClass="output-numeric">
                        <apex:param value="{!TMLTaxTotalSubcontractors}"/>
                    </apex:outputText>
                    <apex:outputText label="Total: " value="{0, number, ###,##0.00}" styleClass="output-numeric">
                        <apex:param value="{!TMLtotalSubcontractors}"/>
                    </apex:outputText>
                </apex:pageBlockSection>
            </div>

            <apex:pageBlockSection id="theWasteDisposalSection" columns="1" title="Waste Disposal Lines"
                                   collapsible="true">

                <apex:outputPanel styleClass="tmLineWrap" layout="block">
                    <apex:pageBlockTable id="theTMLWasteDisposalTable" value="{!TMLListWasteDisposal}" var="line"
                                         rendered="{!NOT(ISNULL(TMLListWasteDisposal))}">
                        <apex:column headerValue="Action" styleClass="actionColumn" style="width:60px">
                            <apex:commandButton value="Delete" disabled="{!afterInvoiced}" onclick="if(!confirmDelete()){return false};"
                                                action="{!deleteLine}" reRender="theTMLWasteDisposalTable">
                                <apex:param id="objectType" name="objectType" value="TMLine"/>
                                <apex:param id="displayId" name="displayId" value="{!line.Line_No__c}"/>
                                <apex:param id="lineType" name="lineType" value="Waste Disposal"/>
                            </apex:commandButton>
                        </apex:column>

                        <apex:column headerValue="Waste Disposal">
                            <apex:outputpanel rendered="{!afterInvoiced != true && line.System_Calculated_Line__c == false}">
                                <div class="requiredInput">
                                    <div class="requiredBlock"></div>
                                    <c:CustomLookup componentId="{!$Component.theTMLWasteDisposalTable}:theWResource"
                                                    styleClass="input-lookup"
                                                    style="width: 100px"
                                                    filterClause="Blocked__c=false AND Category__c = \'Waste Disposal\'"
                                                    secondaryDisplayField="Description__c"
                                                    minSearchLength="1"
                                                    stealFocus="true"
                                                    sObjectType="TM_Line__c"
                                                    sObject="{!line}"
                                                    sObjectField="Resource__c"
                                                    onchange="validateFieldInList(this);"

                                                    allowtoBlank="true"
                                                    LookupObject="Resource__c"
                                                    LinkFieldName="Name"
                                                    FieldSetName="WasteFieldSet"
                                                    RunValidation="True"
                                                    LookupType="ID"
                                                    ValidateFunction="validateField"

                                                    FilterName1="Category__c"
                                                    FilterNameValue1="Waste Disposal"
                                                    FilterOperation1="Category__c"
                                                    FilterOperationValue1="="
                                                    FilterType1="Category__c"
                                                    FilterTypeValue1="String"

                                                    FilterName2="Blocked__c"
                                                    FilterNameValue2="false"
                                                    FilterOperation2="Blocked__c"
                                                    FilterOperationValue2="="
                                                    FilterType2="Blocked__c"
                                                    FilterTypeValue2="Boolean"

                                                    fltr1="true"
                                                    fltr2="true"
                                                    fltr3="true"
                                                    fltr4="true"
                                                    fltr5="true"
                                                    fltr6="true"
                                                    fltr7="true"/>
                                </div>
                            </apex:outputpanel>

                            <apex:outputField value="{!line.Resource__c}" rendered="{!afterInvoiced || line.System_Calculated_Line__c == true}"/>
                        </apex:column>


                        <apex:column headerValue="{!$ObjectType.TM_Line__c.fields.Description__c.Label}">
                            <apex:inputField id="theDescription" value="{!line.Description__c}" rendered="{!line.System_Calculated_Line__c != true}"/>
                            <apex:outputField value="{!line.Description__c}" rendered="{!afterInvoiced || line.System_Calculated_Line__c == true}" />
                        </apex:column>

                        <apex:column headerValue="{!$ObjectType.TM_Line__c.fields.Quantity__c.Label}">
                            <apex:inputField id="theWQuantity" value="{!line.Quantity__c}"
                                             onchange="validateFieldInList(this);"/>
                        </apex:column>
                        
                        <apex:column headerValue="{!$ObjectType.TM_Line__c.fields.Unit_of_Measure__c.Label}">
                            <apex:outputpanel rendered="{!line.System_Calculated_Line__c != true
                                                    && (line.Resource__c == theCompanySetup.Default_Waste_Disposal_Resource__c
                                                            || (line.Resource__r.Has_Container__c != true && line.Resource__r.Has_Weight_Volume__c != true))}">
                                <div class="requiredInput">
                                    <div class="requiredBlock"></div>
                                    <c:CustomLookup componentId="{!$Component.theTMLWasteDisposalTable}:theWUOM"
                                                    styleClass="input-lookup"
                                                    style="width: 100px"
                                                    secondaryDisplayField="Description__c"
                                                    minSearchLength="1"
                                                    stealFocus="true"
                                                    sObjectType="TM_Line__c"
                                                    sObject="{!line}"
                                                    sObjectField="Unit_of_Measure__c"
                                                    onchange="validateFieldInList(this);"

                                                    allowtoBlank="true"
                                                    LookupObject="Unit_of_Measure__c"
                                                    LinkFieldName="Name"
                                                    FieldSetName="UOMFieldSet"
                                                    RunValidation="True"
                                                    LookupType="ID"
                                                    ValidateFunction="validateField"

                                                    fltr1="true"
                                                    fltr2="true"
                                                    fltr3="true"
                                                    fltr4="true"
                                                    fltr5="true"
                                                    fltr6="true"
                                                    fltr7="true"
                                    />
                                </div>
                            </apex:outputpanel>
                            <apex:outputField value="{!line.Unit_of_Measure__c}"
                                              rendered="{!(afterInvoiced || line.System_Calculated_Line__c == true) &&
                                                                (line.Resource__c == theCompanySetup.Default_Waste_Disposal_Resource__c
                                                                    || (line.Resource__r.Has_Weight_Volume__c == true || line.Resource__r.Has_Container__c == true))}" />
                        </apex:column>

                        <apex:column headerValue="{!$ObjectType.TM_Line__c.fields.Cost_Method__c.Label}">
                            <apex:outputPanel rendered="{!line.System_Calculated_Line__c != true
                                                            && (line.Resource__c != theCompanySetup.Default_Waste_Disposal_Resource__c
                                                            && (line.Resource__r.Has_Weight_Volume__c == true || line.Resource__r.Has_Container__c == true))}">
                                <div class="requiredInput">
                                    <div class="requiredBlock"></div>
                                    <apex:inputField id="theWCostMethod" value="{!line.Cost_Method__c}" onChange="validateFieldInList(this)"/>
                                </div>
                            </apex:outputPanel>
                            <apex:outputField value="{!line.Cost_Method__c}"
                                              rendered="{!(afterInvoiced || line.System_Calculated_Line__c == true)
                                                && (line.Resource__c != theCompanySetup.Default_Waste_Disposal_Resource__c
                                                      || (line.Resource__r.Has_Container__c != true && line.Resource__r.Has_Weight_Volume__c != true))}" />
                        </apex:column>
                        <apex:column headerValue="{!$ObjectType.TM_Line__c.fields.Container_Size__c.Label}">
                            <apex:outputpanel rendered="{!line.System_Calculated_Line__c != true
                                                            && (line.Resource__c != theCompanySetup.Default_Waste_Disposal_Resource__c
                                                            && (line.Resource__r.Has_Weight_Volume__c == true || line.Resource__r.Has_Container__c == true))}">
                                <c:CustomLookup componentId="{!$Component.theTMLWasteDisposalTable}:theWContainerSize"
                                                styleClass="input-lookup"
                                                style="width: 100px"
                                                filterClause="Blocked__c=false AND Container_Size__c=true"
                                                secondaryDisplayField="Description__c"
                                                minSearchLength="1"
                                                stealFocus="true"
                                                sObjectType="TM_Line__c"
                                                sObject="{!line}"
                                                sObjectField="Container_Size__c"
                                                onchange="validateFieldInList(this);"

                                                allowtoBlank="true"
                                                LookupObject="Unit_of_Measure__c"
                                                LinkFieldName="Name"
                                                FieldSetName="UOMFieldSet"
                                                RunValidation="True"
                                                LookupType="ID"
                                                ValidateFunction="validateField"

                                                FilterName1="Container_Size__c"
                                                FilterNameValue1="true"
                                                FilterOperation1="Container_Size__c"
                                                FilterOperationValue1="="
                                                FilterType1="Container_Size__c"
                                                FilterTypeValue1="Boolean"

                                                FilterName2="Blocked__c"
                                                FilterNameValue2="false"
                                                FilterOperation2="Blocked__c"
                                                FilterOperationValue2="="
                                                FilterType2="Blocked__c"
                                                FilterTypeValue2="Boolean"

                                                fltr1="true"
                                                fltr2="true"
                                                fltr3="true"
                                                fltr4="true"
                                                fltr5="true"
                                                fltr6="true"
                                                fltr7="true"
                                />
                            </apex:outputpanel>
                            <apex:outputField value="{!line.Container_Size__c}"
                                              rendered="{!(afterInvoiced || line.System_Calculated_Line__c == true)
                                                && (line.Resource__c != theCompanySetup.Default_Waste_Disposal_Resource__c
                                                      || (line.Resource__r.Has_Container__c != true && line.Resource__r.Has_Weight_Volume__c != true))}" />
                        </apex:column>

                        <apex:column headerValue="{!$ObjectType.TM_Line__c.fields.Unit_Weight_Vol__c.Label}">
                            <apex:outputpanel rendered="{!line.System_Calculated_Line__c != true
                                                            && (line.Resource__c != theCompanySetup.Default_Waste_Disposal_Resource__c
                                                            && (line.Resource__r.Has_Weight_Volume__c == true || line.Resource__r.Has_Container__c == true))}">
                                <c:CustomLookup componentId="{!$Component.theTMLWasteDisposalTable}:theWUnitVol"
                                                styleClass="input-lookup"
                                                style="width: 100px"
                                                filterClause="Blocked__c=false AND Weight_Volume__c=true"
                                                secondaryDisplayField="Description__c"
                                                minSearchLength="1"
                                                stealFocus="true"
                                                sObjectType="TM_Line__c"
                                                sObject="{!line}"
                                                sObjectField="Unit_Weight_Vol__c"
                                                onchange="validateFieldInList(this);"

                                                allowtoBlank="true"
                                                LookupObject="Unit_of_Measure__c"
                                                LinkFieldName="Name"
                                                FieldSetName="UOMFieldSet"
                                                RunValidation="True"
                                                LookupType="ID"
                                                ValidateFunction="validateField"

                                                FilterName1="Weight_Volume__c"
                                                FilterNameValue1="true"
                                                FilterOperation1="Weight_Volume__c"
                                                FilterOperationValue1="="
                                                FilterType1="Weight_Volume__c"
                                                FilterTypeValue1="Boolean"

                                                FilterName2="Blocked__c"
                                                FilterNameValue2="false"
                                                FilterOperation2="Blocked__c"
                                                FilterOperationValue2="="
                                                FilterType2="Blocked__c"
                                                FilterTypeValue2="Boolean"

                                                fltr1="true"
                                                fltr2="true"
                                                fltr3="true"
                                                fltr4="true"
                                                fltr5="true"
                                                fltr6="true"
                                                fltr7="true"
                                />
                            </apex:outputpanel>
                            <apex:outputField value="{!line.Unit_Weight_Vol__c}"
                                              rendered="{!(afterInvoiced || line.System_Calculated_Line__c == true)
                                                && (line.Resource__c != theCompanySetup.Default_Waste_Disposal_Resource__c
                                                      || (line.Resource__r.Has_Container__c != true && line.Resource__r.Has_Weight_Volume__c != true))}" />
                        </apex:column>

                        <apex:column headerValue="{!$ObjectType.TM_Line__c.fields.Facility__c.Label}">
                            <apex:outputpanel rendered="{!NOT(line.System_Calculated_Line__c)}">
                                <c:CustomLookup componentId="{!$Component.theTMLWasteDisposalTable}:theWFacility"
                                                styleClass="input-lookup"
                                                style="width: 100px"
                                                secondaryDisplayField=""
                                                minSearchLength="1"
                                                stealFocus="true"
                                                sObjectType="TM_Line__c"
                                                sObject="{!line}"
                                                sObjectField="Facility__c"
                                                onchange="validateFieldInList(this);"

                                                allowtoBlank="true"
                                                LookupObject="Facility__c"
                                                LinkFieldName="Name"
                                                FieldSetName="FacilityFieldSet"
                                                RunValidation="True"
                                                LookupType="ID"
                                                ValidateFunction="validateField"

                                                FilterName2="Blocked__c"
                                                FilterNameValue2="false"
                                                FilterOperation2="Blocked__c"
                                                FilterOperationValue2="="
                                                FilterType2="Blocked__c"
                                                FilterTypeValue2="Boolean"

                                                fltr1="true"
                                                fltr2="true"
                                                fltr3="true"
                                                fltr4="true"
                                                fltr5="true"
                                                fltr6="true"
                                                fltr7="true"
                                />
                            </apex:outputpanel>
                            <apex:outputField value="{!line.Facility__c}" rendered="{!line.System_Calculated_Line__c}" />
                        </apex:column>
                        <apex:column headerValue="{!$ObjectType.TM_Line__c.fields.Min_Sell_Qty__c.Label}">
                            <apex:outputPanel rendered="{!line.Resource__c != theCompanySetup.Default_Waste_Disposal_Resource__c}">
                                <apex:outputField value="{!line.Min_Sell_Qty__c}" />
                            </apex:outputPanel>
                        </apex:column>
                        <apex:column headerValue="{!$ObjectType.TM_Line__c.fields.BOL_Manifest__c.Label}">
                            <apex:inputField id="theBOLManifest" value="{!line.BOL_Manifest__c}"/>
                        </apex:column>

                        <apex:column rendered="{!afterConfirmed}"
                                     headerValue="{!$ObjectType.TM_Line__c.fields.Unit_Price__c.Label}">
                            <apex:inputField id="theWUnitPrice" value="{!line.Unit_Price__c}"
                                             onchange="validateFieldInList(this)" style="width:60px"
                                             styleClass="UnitPrice input-numeric"
                                             rendered="{!line.System_Calculated_Line__c != true}" />
                            <apex:outputField value="{!line.Unit_Price__c}"
                                              rendered="{!afterInvoiced || line.System_Calculated_Line__c == true}" />
                        </apex:column>

                        <apex:column headerValue="{!$ObjectType.TM_Line__c.fields.Unit_Cost__c.Label}">
                            <apex:outputText value="{0, number, ###,##0.00}"
                                             styleClass="LineCost output-numeric" style="width:60px"
                                             rendered="{!line.Resource__c != theCompanySetup.Default_Waste_Disposal_Resource__c || afterInvoiced}">
                                <apex:param value="{!line.Unit_Cost__c}"/>
                            </apex:outputText>

                            <apex:inputField id="theWUnitCost" value="{!line.Unit_Cost__c}"
                                             onchange="validateFieldInList(this)" style="width:60px"
                                             styleClass="UnitPrice input-numeric"
                                             rendered="{!(line.Resource__c == theCompanySetup.Default_Waste_Disposal_Resource__c && !afterInvoiced && afterConfirmed && line.System_Calculated_Line__c != true) || (line.System_Calculated_Line__c != true && (line.Unit_Cost__c == null || line.Unit_Cost__c == 0))}" />

                        </apex:column>

                        <apex:column rendered="{!afterConfirmed}" headerValue="{!$ObjectType.TM_Line__c.fields.Pricing_Source_2__c.Label}">
                            <apex:outputField value="{!line.Pricing_Source_2__c}"/>
                        </apex:column>



                        <apex:column rendered="{!afterConfirmed}"
                                     headerValue="{!$ObjectType.TM_Line__c.fields.Tax_Group__c.Label}">
                            <apex:inputField id="theWTaxGroup" value="{!line.Tax_Group__c}"
                                             onchange="validateFieldInList(this);" style="width:60px"
                                             styleClass="input-description"/>
                        </apex:column>


                        <apex:column rendered="{!afterConfirmed}" headerValue="{!$ObjectType.TM_Line__c.fields.Bill_as_Lump_Sum__c.Label}">
                            <apex:inputField id="theWBillasLumpSum" value="{!line.Bill_as_Lump_Sum__c}" onchange="validateFieldInList(this);"/>
                        </apex:column>
                        <apex:column rendered="{!afterConfirmed}" headerValue="{!$ObjectType.TM_Line__c.fields.Non_Billable__c.Label}">
                            <apex:inputField id="theWNonBillable" value="{!line.Non_Billable__c}" onchange="validateFieldInList(this);"/>
                        </apex:column>


                        <apex:column rendered="{!afterConfirmed}"
                                     headerValue="{!$ObjectType.TM_Line__c.fields.Line_Amount__c.Label}">
                            <apex:outputText id="theLineAmount" value="{0, number, ###,##0.00}"
                                             styleClass="LineCost output-numeric" style="width:60px">
                                <apex:param value="{!line.Line_Amount__c}"/>
                            </apex:outputText>
                        </apex:column>
                        <apex:column rendered="{!afterConfirmed}"
                                     headerValue="{!$ObjectType.TM_Line__c.fields.Line_Amt_Incl_Tax__c.Label}">
                            <apex:outputText id="theAmtInclTax" value="{0, number, ###,##0.00}"
                                             styleClass="LineCost output-numeric" style="width:60px">
                                <apex:param value="{!line.Line_Amt_Incl_Tax__c}"/>
                            </apex:outputText>
                        </apex:column>

                        <apex:column rendered="{!TM.Contract__c!=null&&afterConfirmed}"  headerValue="{!$ObjectType.TM_Line__c.fields.Contract_Line__c.Label}">
                            <apex:outputpanel >
                                <c:CustomLookup componentId="{!$Component.theTMLWasteDisposalTable}:theWDContractLine"
                                                styleClass="input-lookup"
                                                style="width: 100px"
                                                secondaryDisplayField="Customer_Description__c"
                                                minSearchLength="1"
                                                stealFocus="true"
                                                sObjectType="TM_Line__c"
                                                sObject="{!line}"
                                                sObjectField="Contract_Line__c"
                                                onchange="validateFieldInList(this);"

                                                allowtoBlank="true"
                                                LookupObject="Contract_Line__c"
                                                LinkFieldName="Name"
                                                FieldSetName="CLFieldSet"
                                                RunValidation="True"
                                                LookupType="ID"
                                                ValidateFunction="validateField"

                                                FilterName1="Resource_Category__c"
                                                FilterNameValue1="Waste Disposal"
                                                FilterOperation1="Resource_Category__c"
                                                FilterOperationValue1="="
                                                FilterType1="Resource_Category__c"
                                                FilterTypeValue1="String"

                                                FilterName2="Resource__c"
                                                FilterNameValue2="{!line.Resource__c}"
                                                FilterOperation2="Resource__c"
                                                FilterOperationValue2="="
                                                FilterType2="Resource__c"
                                                FilterTypeValue2="String"

                                                FilterName3="Contract__c"
                                                FilterNameValue3="{!TM.Contract__c}"
                                                FilterOperation3="Contract__c"
                                                FilterOperationValue3="="
                                                FilterType3="Contract__c"
                                                FilterTypeValue3="String"

                                                fltr1="true"
                                                fltr2="true"
                                                fltr3="true"
                                                fltr4="true"
                                                fltr5="true"
                                                fltr6="true"
                                                fltr7="true"
                                />
                            </apex:outputpanel>
                        </apex:column>

                        <apex:column rendered="{!TM.Sales_Order__c!=null&&afterConfirmed}" headerValue="{!$ObjectType.TM_Line__c.fields.Sales_Line__c.Label}">
                            <apex:inputField id="theQuoteLine" value="{!line.Sales_Line__c}" style="width: 100px"/>
                        </apex:column>

                        <apex:column headerValue="{!$ObjectType.TM_Line__c.fields.Invoiced__c.Label}">
                            <apex:outputField value="{!line.Invoiced__c}" style="width:50px"/>
                        </apex:column>
                        <apex:column headerValue="{!$ObjectType.TM_Line__c.fields.Line_No__c.Label}">
                            <apex:outputField id="theLineNo" value="{!line.Line_No__c}" style="width:50px"/>
                        </apex:column>
                    </apex:pageBlockTable>
                </apex:outputPanel>
            </apex:pageBlockSection>

            <apex:outputPanel >
                <apex:commandButton value="Add Lines" disabled="{!afterInvoiced}" action="{!addLine}"
                                    reRender="theTMLWasteDisposalTable,theMessage">
                    <apex:param name="ObjectType" value="TMLine"/>
                    <apex:param name="LineCategory" value="Waste Disposal"/>
                </apex:commandButton>
            </apex:outputPanel>
            <div style="float:right;width:600px;font-size:150%;">
                <apex:pageBlockSection rendered="{!afterConfirmed}"
                                       id="TMLWasteDisposalTotal" columns="3">
                    <apex:outputText label="SubTotal: " value="{0, number, ###,##0.00}" styleClass="output-numeric">
                        <apex:param value="{!TMLSubtotalWasteDisposal}"/>
                    </apex:outputText>
                    <apex:outputText label="Tax: " value="{0, number, ###,##0.00}" styleClass="output-numeric">
                        <apex:param value="{!TMLTaxTotalWasteDisposal}"/>
                    </apex:outputText>
                    <apex:outputText label="Total: " value="{0, number, ###,##0.00}" styleClass="output-numeric">
                        <apex:param value="{!TMLtotalWasteDisposal}"/>
                    </apex:outputText>
                </apex:pageBlockSection>
            </div>

            <apex:pageBlockSection rendered="{!afterConfirmed}"
                                   id="theDemurrageSection" columns="1" title="Transportation, Demurrage and Fees" collapsible="true">

                <apex:outputPanel styleClass="tmLineWrap" layout="block">
                    <apex:pageBlockTable id="theTMLDemurrageTable" value="{!TMLListDemurrage}" var="line"
                                         rendered="{!NOT(ISNULL(TMLListDemurrage))}">
                        <apex:column headerValue="Action" styleClass="actionColumn" style="width:60px">
                            <apex:commandButton value="Delete" disabled="{!afterInvoiced}" onclick="if(!confirmDelete()){return false};"
                                                action="{!deleteLine}" reRender="theTMLDemurrageTable">
                                <apex:param id="objectType" name="objectType" value="TMLine"/>
                                <apex:param id="displayId" name="displayId" value="{!line.Line_No__c}"/>
                                <apex:param id="lineType" name="lineType" value="Demurrage"/>
                            </apex:commandButton>
                        </apex:column>
                        <apex:column headerValue="Service">

                            <apex:outputpanel >
                                <div class="requiredInput">
                                    <div class="requiredBlock"></div>
                                    <c:CustomLookup componentId="{!$Component.theTMLDemurrageTable}:theDResource"
                                                    styleClass="input-lookup"
                                                    style="width: 100px"
                                                    filterClause="Blocked__c=false AND Category__c = \'Demurrage\'"
                                                    secondaryDisplayField="Description__c"
                                                    minSearchLength="1"
                                                    stealFocus="true"
                                                    sObjectType="TM_Line__c"
                                                    sObject="{!line}"
                                                    sObjectField="Resource__c"
                                                    onchange="validateFieldInList(this);"

                                                    allowtoBlank="true"
                                                    LookupObject="Resource__c"
                                                    LinkFieldName="Name"
                                                    FieldSetName="ResourceFieldSet"
                                                    RunValidation="True"
                                                    LookupType="ID"
                                                    ValidateFunction="validateField"

                                                    FilterName1="Category__c"
                                                    FilterNameValue1="Demurrage"
                                                    FilterOperation1="Category__c"
                                                    FilterOperationValue1="="
                                                    FilterType1="Category__c"
                                                    FilterTypeValue1="String"

                                                    FilterName2="Blocked__c"
                                                    FilterNameValue2="false"
                                                    FilterOperation2="Blocked__c"
                                                    FilterOperationValue2="="
                                                    FilterType2="Blocked__c"
                                                    FilterTypeValue2="Boolean"

                                                    fltr1="true"
                                                    fltr2="true"
                                                    fltr3="true"
                                                    fltr4="true"
                                                    fltr5="true"
                                                    fltr6="true"
                                                    fltr7="true"/>
                                </div>
                            </apex:outputpanel>

                        </apex:column>
                        <apex:column headerValue="{!$ObjectType.TM_Line__c.fields.Description__c.Label}">
                            <apex:inputField id="theDDescription" value="{!line.Description__c}"/>
                        </apex:column>
                        <apex:column headerValue="{!$ObjectType.TM_Line__c.fields.Site_Start_Time__c.Label}">
                            <apex:inputField id="theDSiteStartTime" onchange="validateFieldInList(this);"
                                             onkeyup="insertColon(this, event);"
                                             onkeypress="return isNumber(event);"
                                             value="{!line.Site_Start_Time__c}"/>
                        </apex:column>
                        <apex:column headerValue="{!$ObjectType.TM_Line__c.fields.Site_End_Time__c.Label}">
                            <apex:inputField id="theDSiteEndTime" onchange="validateFieldInList(this);"
                                             onkeyup="insertColon(this, event);"
                                             onkeypress="return isNumber(event);"
                                             value="{!line.Site_End_Time__c}"/>
                        </apex:column>
                        <apex:column headerValue="{!$ObjectType.TM_Line__c.fields.Hour__c.Label}">
                            <apex:outputField id="theHour" value="{!line.Hour__c}" style="width:60px"/>
                        </apex:column>
                        <apex:column headerValue="Quantity">
                            <apex:inputField id="theDQuantity" value="{!line.Quantity__c}"
                                             onchange="validateFieldInList(this);"/>
                        </apex:column>
                        <apex:column headerValue="{!$ObjectType.TM_Line__c.fields.Unit_of_Measure__c.Label}">
                            <apex:outputpanel >
                                <div class="requiredInput">
                                    <div class="requiredBlock"></div>
                                    <c:CustomLookup componentId="{!$Component.theTMLDemurrageTable}:theDUOM"
                                                    styleClass="input-lookup"
                                                    style="width: 100px"
                                                    secondaryDisplayField="Description__c"
                                                    minSearchLength="1"
                                                    stealFocus="true"
                                                    sObjectType="TM_Line__c"
                                                    sObject="{!line}"
                                                    sObjectField="Unit_of_Measure__c"
                                                    onchange="validateFieldInList(this);"

                                                    allowtoBlank="true"
                                                    LookupObject="Unit_of_Measure__c"
                                                    LinkFieldName="Name"
                                                    FieldSetName="UOMFieldSet"
                                                    RunValidation="True"
                                                    LookupType="ID"
                                                    ValidateFunction="validateField"

                                                    FilterName1Special="Resource"
                                                    FilterNameValue1Special="{!line.Resource__c}"
                                                    FilterOperation1Special="Resource"
                                                    FilterOperationValue1Special="="
                                                    FilterType1Special="Resource"
                                                    FilterTypeValue1Special="string"

                                                    calledFrom="TM"
                                                    calledFor="DUOMLookUp"
                                                    isSpecialScenario="true"

                                                    fltr1="true"
                                                    fltr2="true"
                                                    fltr3="true"
                                                    fltr4="true"
                                                    fltr5="true"
                                                    fltr6="true"
                                                    fltr7="true"
                                    />
                                </div>


                            </apex:outputpanel>
                        </apex:column>
                        <apex:column rendered="{!afterConfirmed}"
                                     headerValue="{!$ObjectType.TM_Line__c.fields.Unit_Price__c.Label}">
                            <apex:inputField id="theDUnitPrice" value="{!line.Unit_Price__c}"
                                             onchange="validateFieldInList(this);" style="width:60px"
                                             styleClass="UnitPrice input-numeric"/>
                        </apex:column>
                        <apex:column rendered="{!afterConfirmed}" headerValue="{!$ObjectType.TM_Line__c.fields.Pricing_Source_2__c.Label}">
                            <apex:outputField value="{!line.Pricing_Source_2__c}"/>
                        </apex:column>

                        <apex:column rendered="{!afterConfirmed}"
                                     headerValue="{!$ObjectType.TM_Line__c.fields.Tax_Group__c.Label}">
                            <apex:inputField id="theDTaxGroup" value="{!line.Tax_Group__c}"
                                             onchange="validateFieldInList(this);" style="width:60px"
                                             styleClass="input-description"/>
                        </apex:column>


                        <apex:column rendered="{!afterConfirmed}" headerValue="{!$ObjectType.TM_Line__c.fields.Bill_as_Lump_Sum__c.Label}">
                            <apex:inputField id="theDBillasLumpSum" value="{!line.Bill_as_Lump_Sum__c}" onchange="validateFieldInList(this);"/>
                        </apex:column>
                        <apex:column rendered="{!afterConfirmed}" headerValue="{!$ObjectType.TM_Line__c.fields.Non_Billable__c.Label}">
                            <apex:inputField id="theDNonBillable" value="{!line.Non_Billable__c}" onchange="validateFieldInList(this);"/>
                        </apex:column>


                        <apex:column rendered="{!afterConfirmed}"
                                     headerValue="{!$ObjectType.TM_Line__c.fields.Line_Amount__c.Label}">
                            <apex:outputText id="theLineAmount" value="{0, number, ###,##0.00}"
                                             styleClass="LineCost output-numeric" style="width:60px">
                                <apex:param value="{!line.Line_Amount__c}"/>
                            </apex:outputText>
                        </apex:column>
                        <apex:column rendered="{!afterConfirmed}"
                                     headerValue="{!$ObjectType.TM_Line__c.fields.Line_Amt_Incl_Tax__c.Label}">
                            <apex:outputText id="theAmtInclTax" value="{0, number, ###,##0.00}"
                                             styleClass="LineCost output-numeric" style="width:60px">
                                <apex:param value="{!line.Line_Amt_Incl_Tax__c}"/>
                            </apex:outputText>
                        </apex:column>

                        <apex:column rendered="{!TM.Contract__c!=null&&afterConfirmed}"  headerValue="{!$ObjectType.TM_Line__c.fields.Contract_Line__c.Label}">
                            <apex:outputpanel >
                                <c:CustomLookup componentId="{!$Component.theTMLDemurrageTable}:theTMLDemurrageContractLine"
                                                styleClass="input-lookup"
                                                style="width: 100px"
                                                secondaryDisplayField="Customer_Description__c"
                                                minSearchLength="1"
                                                stealFocus="true"
                                                sObjectType="TM_Line__c"
                                                sObject="{!line}"
                                                sObjectField="Contract_Line__c"
                                                onchange="validateFieldInList(this);"

                                                allowtoBlank="true"
                                                LookupObject="Contract_Line__c"
                                                LinkFieldName="Name"
                                                FieldSetName="CLFieldSet"
                                                RunValidation="True"
                                                LookupType="ID"
                                                ValidateFunction="validateField"

                                                FilterName1="Resource_Category__c"
                                                FilterNameValue1="Demurrage"
                                                FilterOperation1="Resource_Category__c"
                                                FilterOperationValue1="="
                                                FilterType1="Resource_Category__c"
                                                FilterTypeValue1="String"

                                                FilterName2="Resource__c"
                                                FilterNameValue2="{!line.Resource__c}"
                                                FilterOperation2="Resource__c"
                                                FilterOperationValue2="="
                                                FilterType2="Resource__c"
                                                FilterTypeValue2="String"

                                                FilterName3="Contract__c"
                                                FilterNameValue3="{!TM.Contract__c}"
                                                FilterOperation3="Contract__c"
                                                FilterOperationValue3="="
                                                FilterType3="Contract__c"
                                                FilterTypeValue3="String"

                                                fltr1="true"
                                                fltr2="true"
                                                fltr3="true"
                                                fltr4="true"
                                                fltr5="true"
                                                fltr6="true"
                                                fltr7="true"
                                />
                            </apex:outputpanel>
                        </apex:column>

                        <apex:column rendered="{!TM.Sales_Order__c!=null&&afterConfirmed}" headerValue="{!$ObjectType.TM_Line__c.fields.Sales_Line__c.Label}">
                            <apex:inputField id="theQuoteLine" value="{!line.Sales_Line__c}" style="width: 100px"/>
                        </apex:column>

                        <apex:column headerValue="{!$ObjectType.TM_Line__c.fields.Invoiced__c.Label}">
                            <apex:outputField value="{!line.Invoiced__c}" style="width:50px"/>
                        </apex:column>
                        <apex:column rendered="{!afterConfirmed}"
                                     headerValue="{!$ObjectType.TM_Line__c.fields.Line_No__c.Label}">
                            <apex:outputField id="theLineNo" value="{!line.Line_No__c}" style="width:50px"/>
                        </apex:column>
                    </apex:pageBlockTable>
                </apex:outputPanel>
            </apex:pageBlockSection>

            <apex:outputPanel rendered="{!afterConfirmed}">
                <apex:commandButton value="Add Lines" disabled="{!afterInvoiced}" action="{!addLine}" reRender="theTMLDemurrageTable,theMessage">
                    <apex:param name="ObjectType" value="TMLine"/>
                    <apex:param name="LineCategory" value="Demurrage"/>
                </apex:commandButton>
            </apex:outputPanel>
            <div style="float:right;width:600px;font-size:150%;">
                <apex:pageBlockSection rendered="{!afterConfirmed}"
                                       id="TMLDemurrageTotal" columns="3">
                    <apex:outputText label="SubTotal: " value="{0, number, ###,##0.00}" styleClass="output-numeric">
                        <apex:param value="{!TMLSubtotalDemurrage}"/>
                    </apex:outputText>
                    <apex:outputText label="Tax: " value="{0, number, ###,##0.00}" styleClass="output-numeric">
                        <apex:param value="{!TMLTaxTotalDemurrage}"/>
                    </apex:outputText>
                    <apex:outputText label="Total: " value="{0, number, ###,##0.00}" styleClass="output-numeric">
                        <apex:param value="{!TMLtotalDemurrage}"/>
                    </apex:outputText>
                </apex:pageBlockSection>
            </div>

            <apex:pageBlockSection id="theLumpSumSection" columns="1" title="Lump Sum/Bundled Lines" collapsible="true">

                <apex:outputPanel styleClass="tmLineWrap" layout="block">
                    <apex:pageBlockTable id="theTMLLumpSumTable" value="{!TMLListLumpSum}" var="line"
                                         rendered="{!NOT(ISNULL(TMLListLumpSum))}">
                        <apex:column headerValue="Action" styleClass="actionColumn" style="width:60px">
                            <apex:commandButton value="Delete" disabled="{!afterInvoiced}" onclick="if(!confirmDelete()){return false};"
                                                action="{!deleteLine}" reRender="theTMLLumpSumTable">
                                <apex:param id="objectType" name="objectType" value="TMLine"/>
                                <apex:param id="displayId" name="displayId" value="{!line.Line_No__c}"/>
                                <apex:param id="lineType" name="lineType" value="Lump Sum"/>
                            </apex:commandButton>
                        </apex:column>
                        <apex:column headerValue="Resource Type">
                            <apex:outputpanel >
                                <div class="requiredInput">
                                    <div class="requiredBlock"></div>
                                    <c:CustomLookup componentId="{!$Component.theTMLLumpSumTable}:theLumpSumResourceType"
                                                    styleClass="input-lookup"
                                                    style="width: 100px"
                                                    filterClause="Blocked__c=false AND Category__c = \'Lump Sum\'"
                                                    secondaryDisplayField="Description__c"
                                                    minSearchLength="1"
                                                    stealFocus="true"
                                                    sObjectType="TM_Line__c"
                                                    sObject="{!line}"
                                                    sObjectField="Resource_Type__c"
                                                    onchange="validateFieldInList(this);"

                                                    allowtoBlank="true"
                                                    LookupObject="Resource_Type__c"
                                                    LinkFieldName="Name"
                                                    FieldSetName="ResourceTypeFieldSet"
                                                    RunValidation="True"
                                                    LookupType="ID"
                                                    ValidateFunction="validateField"

                                                    FilterName1="Category__c"
                                                    FilterNameValue1="Lump Sum"
                                                    FilterOperation1="Category__c"
                                                    FilterOperationValue1="="
                                                    FilterType1="Category__c"
                                                    FilterTypeValue1="String"

                                                    FilterName2="Blocked__c"
                                                    FilterNameValue2="false"
                                                    FilterOperation2="Blocked__c"
                                                    FilterOperationValue2="="
                                                    FilterType2="Blocked__c"
                                                    FilterTypeValue2="Boolean"

                                                    fltr1="true"
                                                    fltr2="true"
                                                    fltr3="true"
                                                    fltr4="true"
                                                    fltr5="true"
                                                    fltr6="true"
                                                    fltr7="true"/>
                                </div>
                            </apex:outputpanel>
                        </apex:column>
                        <apex:column headerValue="Resource No.">
                            <apex:outputField value="{!line.Resource__c}"/>
                        </apex:column>

                        <apex:column headerValue="{!$ObjectType.TM_Line__c.fields.Description__c.Label}">
                            <apex:inputField id="theLumpDescription" value="{!line.Description__c}"/>
                        </apex:column>
                        <apex:column headerValue="{!$ObjectType.TM_Line__c.fields.Quantity__c.Label}">
                            <apex:inputField id="theLumpQuantity" value="{!line.Quantity__c}"
                                             onchange="validateFieldInList(this)"/>
                        </apex:column>

                        <apex:column headerValue="{!$ObjectType.TM_Line__c.fields.Unit_of_Measure__c.Label}">
                            <apex:outputpanel >
                                <div class="requiredInput">
                                    <div class="requiredBlock"></div>
                                    <c:CustomLookup componentId="{!$Component.theTMLLumpSumTable}:theLumpUOM"
                                                    styleClass="input-lookup"
                                                    style="width: 100px"
                                                    secondaryDisplayField="Description__c"
                                                    minSearchLength="1"
                                                    stealFocus="true"
                                                    sObjectType="TM_Line__c"
                                                    sObject="{!line}"
                                                    sObjectField="Unit_of_Measure__c"
                                                    onchange="validateFieldInList(this);"

                                                    allowtoBlank="true"
                                                    LookupObject="Unit_of_Measure__c"
                                                    LinkFieldName="Name"
                                                    FieldSetName="UOMFieldSet"
                                                    RunValidation="True"
                                                    LookupType="ID"
                                                    ValidateFunction="validateField"

                                                    FilterName1Special="ResourceType"
                                                    FilterNameValue1Special="{!line.Resource_Type__c}"
                                                    FilterOperation1Special="ResourceType"
                                                    FilterOperationValue1Special="="
                                                    FilterType1Special="ResourceType"
                                                    FilterTypeValue1Special="string"

                                                    calledFrom="TM"
                                                    calledFor="ResourceTypeUOMLookup"
                                                    isSpecialScenario="true"

                                                    fltr1="true"
                                                    fltr2="true"
                                                    fltr3="true"
                                                    fltr4="true"
                                                    fltr5="true"
                                                    fltr6="true"
                                                    fltr7="true"
                                    />
                                </div>

                            </apex:outputpanel>
                        </apex:column>
                        <apex:column rendered="{!afterConfirmed}"
                                     headerValue="{!$ObjectType.TM_Line__c.fields.Unit_Price__c.Label}">
                            <apex:inputField id="theLumpUnitPrice" value="{!line.Unit_Price__c}"
                                             onchange="validateFieldInList(this)" style="width:60px"
                                             styleClass="UnitPrice input-numeric"/>
                        </apex:column>
                        <apex:column rendered="{!afterConfirmed}" headerValue="{!$ObjectType.TM_Line__c.fields.Pricing_Source_2__c.Label}">
                            <apex:outputField value="{!line.Pricing_Source_2__c}"/>
                        </apex:column>
                        <apex:column rendered="{!TM.Contract__c!=null&&afterConfirmed}" headerValue="{!$ObjectType.TM_Line__c.fields.Contract_Line__c.Label}">

                            <apex:outputpanel >
                                <c:CustomLookup componentId="{!$Component.theTMLLumpSumTable}:theLumpSumContractLine"
                                                styleClass="input-lookup"
                                                style="width: 100px"
                                                secondaryDisplayField="Name"
                                                minSearchLength="1"
                                                stealFocus="true"
                                                sObjectType="TM_Line__c"
                                                sObject="{!line}"
                                                sObjectField="Contract_Line__c"
                                                onchange="validateFieldInList(this);"

                                                allowtoBlank="true"
                                                LookupObject="Contract_Line__c"
                                                LinkFieldName="Name"
                                                FieldSetName="CLFieldSet"
                                                RunValidation="True"
                                                LookupType="ID"
                                                ValidateFunction="validateField"

                                                FilterName1="Resource_Type_Category__c"
                                                FilterNameValue1="Lump Sum"
                                                FilterOperation1="Resource_Type_Category__c"
                                                FilterOperationValue1="="
                                                FilterType1="Resource_Type_Category__c"
                                                FilterTypeValue1="String"

                                                FilterName2="Resource_Type__c"
                                                FilterNameValue2="{!line.Resource_Type__c}"
                                                FilterOperation2="Resource_Type__c"
                                                FilterOperationValue2="="
                                                FilterType2="Resource_Type__c"
                                                FilterTypeValue2="String"

                                                fltr1="true"
                                                fltr2="true"
                                                fltr3="true"
                                                fltr4="true"
                                                fltr5="true"
                                                fltr6="true"
                                                fltr7="true"
                                />
                            </apex:outputpanel>
                        </apex:column>
                        <apex:column rendered="{!TM.Contract__c!=null&&afterConfirmed}" headerValue="{!$ObjectType.TM_Line__c.fields.Contract_Regular_Rate__c.Label}">
                            <apex:outputField id="theContractRegularRate" value="{!line.Contract_Regular_Rate__c}"/>
                        </apex:column>
                        <apex:column rendered="{!afterConfirmed}"
                                     headerValue="{!$ObjectType.TM_Line__c.fields.Tax_Group__c.Label}">
                            <apex:inputField id="theLumpTaxGroup" value="{!line.Tax_Group__c}"
                                             onchange="validateFieldInList(this)" style="width:60px"
                                             styleClass="input-description"/>
                        </apex:column>
                        <apex:column rendered="{!afterConfirmed}"
                                     headerValue="{!$ObjectType.TM_Line__c.fields.Line_Amount__c.Label}">
                            <apex:outputText id="theLineAmount" value="{0, number, ###,##0.00}"
                                             styleClass="LineCost output-numeric" style="width:60px">
                                <apex:param value="{!line.Line_Amount__c}"/>
                            </apex:outputText>
                        </apex:column>
                        <apex:column rendered="{!afterConfirmed}"
                                     headerValue="{!$ObjectType.TM_Line__c.fields.Line_Amt_Incl_Tax__c.Label}">
                            <apex:outputText id="theAmtInclTax" value="{0, number, ###,##0.00}"
                                             styleClass="LineCost output-numeric" style="width:60px">
                                <apex:param value="{!line.Line_Amt_Incl_Tax__c}"/>
                            </apex:outputText>
                        </apex:column>
                        <apex:column rendered="{!TM.Sales_Order__c!=null&&afterConfirmed}" headerValue="{!$ObjectType.TM_Line__c.fields.Sales_Line__c.Label}">
                            <apex:inputField id="theQuoteLine" value="{!line.Sales_Line__c}" style="width: 100px"/>
                        </apex:column>

                        <apex:column headerValue="{!$ObjectType.TM_Line__c.fields.Invoiced__c.Label}">
                            <apex:outputField value="{!line.Invoiced__c}" style="width:50px"/>
                        </apex:column>
                        <apex:column headerValue="{!$ObjectType.TM_Line__c.fields.Line_No__c.Label}">
                            <apex:outputField id="theLineNo" value="{!line.Line_No__c}" style="width:50px"/>
                        </apex:column>
                    </apex:pageBlockTable>
                </apex:outputPanel>
            </apex:pageBlockSection>

            <apex:outputPanel >
                <apex:commandButton value="Add Lines" disabled="{!afterInvoiced}" action="{!addLine}" reRender="theTMLLumpSumTable,theMessage">
                    <apex:param name="ObjectType" value="TMLine"/>
                    <apex:param name="LineCategory" value="Lump Sum"/>
                </apex:commandButton>
            </apex:outputPanel>
            <div style="float:right;width:600px;font-size:150%;">
                <apex:pageBlockSection rendered="{!afterConfirmed}"
                                       id="TMLLumpSumTotal" columns="3">
                    <apex:outputText label="SubTotal: " value="{0, number, ###,##0.00}" styleClass="output-numeric">
                        <apex:param value="{!TMLSubtotalLumpSum}"/>
                    </apex:outputText>
                    <apex:outputText label="Tax: " value="{0, number, ###,##0.00}" styleClass="output-numeric">
                        <apex:param value="{!TMLTaxTotalLumpSum}"/>
                    </apex:outputText>
                    <apex:outputText label="Total: " value="{0, number, ###,##0.00}" styleClass="output-numeric">
                        <apex:param value="{!TMLtotalLumpSum}"/>
                    </apex:outputText>
                </apex:pageBlockSection>
            </div>

            <apex:pageBlockSection rendered="{!afterConfirmed}"
                                   id="theMiscSection" columns="1" title="Miscellaneous Charges And Taxes Lines"
                                   collapsible="true">

                <apex:outputPanel styleClass="tmLineWrap" layout="block">
                    <apex:pageBlockTable id="theTMLMiscTable" value="{!TMLListMisc}" var="line"
                                         rendered="{!NOT(ISNULL(TMLListMisc))}">
                        <apex:column headerValue="Action" styleClass="actionColumn" style="width:60px">
                            <apex:commandButton value="Delete" disabled="{!afterInvoiced || line.System_Calculated_Line__c == true}" onclick="if(!confirmDelete()){return false};"
                                                action="{!deleteLine}" reRender="theTMLMiscTable">
                                <apex:param id="objectType" name="objectType" value="TMLine"/>
                                <apex:param id="displayId" name="displayId" value="{!line.Line_No__c}"/>
                                <apex:param id="lineType" name="lineType" value="Misc. Charges And Taxes"/>
                            </apex:commandButton>
                        </apex:column>

                        <apex:column headerValue="Service">
                            <apex:outputpanel rendered="{!line.System_Calculated_Line__c != true}">
                                <div class="requiredInput">
                                    <div class="requiredBlock"></div>
                                    <c:CustomLookup componentId="{!$Component.theTMLMiscTable}:theMiscResource"
                                                    styleClass="input-lookup"
                                                    style="width: 100px"
                                                    filterClause="Blocked__c=false AND Category__c = \'Misc. Charges And Taxes\' AND Id != \'{!theCompanySetup.Default_Fuel_Surcharge_Resource__c}\' AND Id !=\'{!theCompanySetup.Default_Energy_Insurance_Resource__c}\'"
                                                    secondaryDisplayField="Description__c"
                                                    minSearchLength="1"
                                                    stealFocus="true"
                                                    sObjectType="TM_Line__c"
                                                    sObject="{!line}"
                                                    sObjectField="Resource__c"
                                                    onchange="validateFieldInList(this);"

                                                    allowtoBlank="true"
                                                    LookupObject="Resource__c"
                                                    LinkFieldName="Name"
                                                    FieldSetName="ResourceFieldSet"
                                                    RunValidation="True"
                                                    LookupType="ID"
                                                    ValidateFunction="validateField"

                                                    FilterName1="Category__c"
                                                    FilterNameValue1="Misc. Charges And Taxes"
                                                    FilterOperation1="Category__c"
                                                    FilterOperationValue1="="
                                                    FilterType1="Category__c"
                                                    FilterTypeValue1="String"

                                                    FilterName2="Blocked__c"
                                                    FilterNameValue2="false"
                                                    FilterOperation2="Blocked__c"
                                                    FilterOperationValue2="="
                                                    FilterType2="Blocked__c"
                                                    FilterTypeValue2="Boolean"

                                                    FilterName3="Id"
                                                    FilterNameValue3="{!theCompanySetup.Default_Energy_Insurance_Resource__c}"
                                                    FilterOperation3="Id"
                                                    FilterOperationValue3="!="
                                                    FilterType3="Id"
                                                    FilterTypeValue3="String"

                                                    FilterName4="Name"
                                                    FilterNameValue4="{!theCompanySetup.Default_Fuel_Surcharge_Resource__r.Name}"
                                                    FilterOperation4="Name"
                                                    FilterOperationValue4="!="
                                                    FilterType4="Name"
                                                    FilterTypeValue4="String"

                                                    fltr1="true"
                                                    fltr2="true"
                                                    fltr3="true"
                                                    fltr4="true"
                                                    fltr5="true"
                                                    fltr6="true"
                                                    fltr7="true"/>
                                </div>
                            </apex:outputpanel>
                            <apex:outputField id="theMiscResource" value="{!line.Resource__c}" rendered="{!line.System_Calculated_Line__c == true}"/>
                        </apex:column>

                        <apex:column headerValue="{!$ObjectType.TM_Line__c.fields.Description__c.Label}">
                            <apex:inputField id="theDescription" value="{!line.Description__c}"/>
                        </apex:column>
                        <apex:column headerValue="{!$ObjectType.TM_Line__c.fields.Quantity__c.Label}">
                            <apex:inputField id="theMiscQuantity" value="{!line.Quantity__c}"
                                             rendered="{!line.System_Calculated_Line__c != true || line.Resource__c == defaultCompanySetting.Rinse_Out_Fee_Resource_Id__c}"
                                             onchange="validateFieldInList(this)"/>
                            <apex:outputField value="{!line.Quantity__c}" rendered="{!line.System_Calculated_Line__c == true && line.Resource__c != defaultCompanySetting.Rinse_Out_Fee_Resource_Id__c}"/>
                        </apex:column>
                        <apex:column headerValue="{!$ObjectType.TM_Line__c.fields.Unit_of_Measure__c.Label}">
                            <apex:outputpanel rendered="{!line.System_Calculated_Line__c != true}">
                                <div class="requiredInput">
                                    <div class="requiredBlock"></div>
                                    <c:CustomLookup componentId="{!$Component.theTMLMiscTable}:theMiscUOM"
                                                    styleClass="input-lookup"
                                                    style="width: 100px"
                                                    secondaryDisplayField="Description__c"
                                                    minSearchLength="1"
                                                    stealFocus="true"
                                                    sObjectType="TM_Line__c"
                                                    sObject="{!line}"
                                                    sObjectField="Unit_of_Measure__c"
                                                    onchange="validateFieldInList(this);"

                                                    allowtoBlank="true"
                                                    LookupObject="Unit_of_Measure__c"
                                                    LinkFieldName="Name"
                                                    FieldSetName="UOMFieldSet"
                                                    RunValidation="True"
                                                    LookupType="ID"
                                                    ValidateFunction="validateField"/>
                                </div>
                            </apex:outputpanel>
                            <apex:outputField value="{!line.Unit_of_Measure__c}" rendered="{!line.System_Calculated_Line__c == true}" />
                        </apex:column>
                        <apex:column rendered="{!afterConfirmed}"
                                     headerValue="{!$ObjectType.TM_Line__c.fields.Unit_Price__c.Label}">
                            <apex:inputField id="theMiscUnitPrice" value="{!line.Unit_Price__c}"
                                             onchange="validateFieldInList(this)" style="width:60px"
                                             styleClass="UnitPrice input-numeric"/>
                        </apex:column>
                        <apex:column headerValue="{!$ObjectType.TM_Line__c.fields.Pricing_Source_2__c.Label}">
                            <apex:outputField value="{!line.Pricing_Source_2__c}"/>
                        </apex:column>
                        <apex:column headerValue="{!$ObjectType.TM_Line__c.fields.Tax_Group__c.Label}">
                            <apex:inputField id="theMiscTaxGroup" value="{!line.Tax_Group__c}"
                                             onchange="validateFieldInList(this)" style="width:60px"
                                             styleClass="input-description"/>
                        </apex:column>


                        <apex:column rendered="{!afterConfirmed}" headerValue="{!$ObjectType.TM_Line__c.fields.Bill_as_Lump_Sum__c.Label}">
                            <apex:inputField id="theMiscBillasLumpSum" value="{!line.Bill_as_Lump_Sum__c}" onchange="validateFieldInList(this);"/>
                        </apex:column>
                        <apex:column rendered="{!afterConfirmed}" headerValue="{!$ObjectType.TM_Line__c.fields.Non_Billable__c.Label}">
                            <apex:inputField id="theMiscNonBillable" value="{!line.Non_Billable__c}" onchange="validateFieldInList(this);"/>
                        </apex:column>


                        <apex:column rendered="{!afterConfirmed}"
                                     headerValue="{!$ObjectType.TM_Line__c.fields.Line_Amount__c.Label}">
                            <apex:outputText id="theLineAmount" value="{0, number, ###,##0.00}"
                                             styleClass="LineCost output-numeric" style="width:60px">
                                <apex:param value="{!line.Line_Amount__c}"/>
                            </apex:outputText>
                        </apex:column>
                        <apex:column rendered="{!afterConfirmed}"
                                     headerValue="{!$ObjectType.TM_Line__c.fields.Line_Amt_Incl_Tax__c.Label}">
                            <apex:outputText id="theAmtInclTax" value="{0, number, ###,##0.00}"
                                             styleClass="LineCost output-numeric" style="width:60px">
                                <apex:param value="{!line.Line_Amt_Incl_Tax__c}"/>
                            </apex:outputText>
                        </apex:column>
                        <apex:column rendered="{!TM.Sales_Order__c!=null&&afterConfirmed}" headerValue="{!$ObjectType.TM_Line__c.fields.Sales_Line__c.Label}">
                            <apex:inputField id="theQuoteLine" value="{!line.Sales_Line__c}" style="width: 100px"/>
                        </apex:column>
                        <apex:column headerValue="{!$ObjectType.TM_Line__c.fields.Invoiced__c.Label}">
                            <apex:outputField value="{!line.Invoiced__c}"/>
                        </apex:column>

                        <apex:column headerValue="{!$ObjectType.TM_Line__c.fields.Invoiced__c.Label}">
                            <apex:outputField value="{!line.Invoiced__c}" style="width:50px"/>
                        </apex:column>
                        <apex:column headerValue="{!$ObjectType.TM_Line__c.fields.Line_No__c.Label}">
                            <apex:outputField id="theLineNo" value="{!line.Line_No__c}" style="width:50px"/>
                        </apex:column>
                    </apex:pageBlockTable>
                </apex:outputPanel>
            </apex:pageBlockSection>

            <apex:outputPanel rendered="{!afterConfirmed}">
                <apex:commandButton value="Add Lines" disabled="{!afterInvoiced}" action="{!addLine}" reRender="theTMLMiscTable,theMessage">
                    <apex:param name="ObjectType" value="TMLine"/>
                    <apex:param name="LineCategory" value="Misc. Charges And Taxes"/>
                </apex:commandButton>
            </apex:outputPanel>
            <div style="float:right;width:600px;font-size:150%;">
                <apex:pageBlockSection rendered="{!afterConfirmed}"
                                       id="TMLMiscTotal" columns="3">
                    <apex:outputText label="SubTotal: " value="{0, number, ###,##0.00}" styleClass="output-numeric">
                        <apex:param value="{!TMLSubtotalMisc}"/>
                    </apex:outputText>
                    <apex:outputText label="Tax: " value="{0, number, ###,##0.00}" styleClass="output-numeric">
                        <apex:param value="{!TMLTaxTotalMisc}"/>
                    </apex:outputText>
                    <apex:outputText label="Total: " value="{0, number, ###,##0.00}" styleClass="output-numeric">
                        <apex:param value="{!TMLtotalMisc}"/>
                    </apex:outputText>
                </apex:pageBlockSection>
            </div>
            <div style="clear:both;">

            </div>

            <div style="float:right;width:600px;font-size:150%;">
                <apex:pageBlockSection rendered="{!afterConfirmed}"
                                       id="TMLTotal" columns="3" title="Invoice Totals" collapsible="false">
                    <apex:outputText label="SubTotal: " value="{0, number, ###,##0.00}" styleClass="output-numeric">
                        <apex:param value="{!TMLSubtotal}"/>
                    </apex:outputText>
                    <apex:outputText label="Tax: " value="{0, number, ###,##0.00}" styleClass="output-numeric">
                        <apex:param value="{!TMLTaxTotal}"/>
                    </apex:outputText>
                    <apex:outputText label="Total: " value="{0, number, ###,##0.00}" styleClass="output-numeric">
                        <apex:param value="{!TMLtotal}"/>
                    </apex:outputText>
                </apex:pageBlockSection>
            </div>


            <div style="clear:both;">

            </div>
            <script>
                $(".tmLineWrap").css("max-width", (screen.width - 100));
            </script>
        </apex:pageBlock>
    </apex:form>
    -->
</apex:page>